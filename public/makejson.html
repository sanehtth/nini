<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Make JSON ‚Äì Builder 6 ph·∫ßn</title>

  <!-- d√πng chung style v·ªõi app ch√≠nh -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="dark.css" />
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />

  <style>
    /* B·ªï sung ch√∫t style ri√™ng cho trang builder, gi·ªØ t√¥ng app c≈© */
    body {
      background: linear-gradient(135deg, #fda4af 0%, #fecaca 30%, #fdf2f8 100%);
    }

    .builder-shell {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 16px 40px;
    }

    .builder-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 20px 22px 26px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.15);
      border: 1px solid #fecaca;
    }

    .builder-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .builder-title {
      font-size: 22px;
      font-weight: 700;
      color: #be123c;
      margin: 0;
    }

    .builder-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .builder-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .builder-row label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
    }

    .builder-row .input,
    .builder-row input[type="text"] {
      flex: 1 1 220px;
      min-width: 220px;
    }

    textarea.builder-textarea {
      width: 100%;
      min-height: 160px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      box-sizing: border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      resize: vertical;
    }

    .builder-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 18px 0 12px;
    }

    .builder-tab-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      font-size: 13px;
      cursor: pointer;
    }

    .builder-tab-btn.active {
      background: #f97373;
      border-color: #f97373;
      color: #fff;
      font-weight: 600;
    }

    .builder-tab-panel {
      display: none;
    }

    .builder-tab-panel.active {
      display: block;
    }

    .builder-section-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .helper-note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .json-output-title {
      margin-top: 14px;
      font-weight: 600;
      font-size: 14px;
    }

    .top-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    #manifestStatus {
      font-size: 13px;
    }

    @media (max-width: 640px) {
      .builder-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="builder-shell">
    <div class="builder-card">
      <!-- HEADER -->
      <div class="builder-header">
        <div>
          <h1 class="builder-title">Make JSON ‚Äì Builder 6 ph·∫ßn</h1>
          <p class="builder-subtitle">
            D√πng ƒë·ªÉ t·∫°o file section JSON &amp; c·∫≠p nh·∫≠t manifest cho b√†i test
            Ti·∫øng Anh.
          </p>
        </div>
        <button class="profile-btn" type="button" onclick="location.href='index.html'">
          ‚¨Ö V·ªÅ trang ch√≠nh
        </button>
      </div>

      <!-- TH√îNG TIN TEST -->
      <section style="margin-bottom:16px;">
        <div class="builder-row">
          <div style="flex:1 1 260px; min-width:260px;">
            <label for="testName">T√™n b√†i test (testName)</label>
            <input
              id="testName"
              type="text"
              class="input"
              placeholder="vd: Test 1"
            />
            <p class="helper-note">
              ƒê√¢y l√† t√™n hi·ªÉn th·ªã &amp; c≈©ng c√≥ th·ªÉ d√πng l√†m prefix ID: Test1,
              Test2, ...
            </p>
          </div>
        </div>

        <div class="builder-row top-actions">
          <button id="btnLoadManifest" type="button" class="main-btn">
            üîÑ N·∫°p sectionsManifest.json
          </button>

          <button id="btnNewSection" type="button" class="main-btn" disabled>
            ‚ûï T·∫°o section m·ªõi
          </button>

          <span id="manifestStatus"></span>
        </div>
      </section>

      <!-- TABS -->
      <div class="builder-tabs">
        <button
          type="button"
          class="builder-tab-btn active"
          data-tab="tab-mcq"
        >
          Ph·∫ßn 1 (MCQ)
        </button>
        <button type="button" class="builder-tab-btn" data-tab="tab-mcqimg">
          Ph·∫ßn 2 (MCQ + h√¨nh)
        </button>
        <button type="button" class="builder-tab-btn" data-tab="tab-readmcq">
          Ph·∫ßn 3 (MCQ / reading)
        </button>
        <button type="button" class="builder-tab-btn" data-tab="tab-dragdrop">
          Ph·∫ßn 4 (Drag &amp; drop)
        </button>
        <button type="button" class="builder-tab-btn" data-tab="tab-wordform">
          Ph·∫ßn 5 (Word form)
        </button>
        <button type="button" class="builder-tab-btn" data-tab="tab-reorder">
          Ph·∫ßn 6 (Reorder / Rewrite)
        </button>
      </div>

      <!-- PANEL: PH·∫¶N 1 (MCQ) -->
      <div id="tab-mcq" class="builder-tab-panel active">
        <h2 class="builder-section-title">
          Ph·∫ßn 1 ‚Äì Tr·∫Øc nghi·ªám (mcqOneByOne)
        </h2>

        <div class="builder-row">
          <div style="flex:1 1 220px; min-width:220px;">
            <label for="sectionId">section.id (s·∫Ω t·ª± nh·∫£y P1_001, P1_002, ...)</label>
            <input
              id="sectionId"
              type="text"
              class="input"
              placeholder="vd: P1_001"
            />
          </div>

          <div style="flex:1 1 260px; min-width:220px;">
            <label for="sectionTitle">section.title (n·∫øu ƒë·ªÉ tr·ªëng s·∫Ω t·ª± sinh)</label>
            <input
              id="sectionTitle"
              type="text"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 1 - Tr·∫Øc nghi·ªám"
            />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="rawP1">N·ªôi dung th√¥ (c√¢u 1‚Äì14)</label>
          <textarea
            id="rawP1"
            class="builder-textarea"
            placeholder="C√¢u 1. ...
C√¢u 2. ...
C√¢u 3. ..."
          ></textarea>
          <p class="helper-note">
            M·ªói c√¢u m·ªôt d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng ‚ÄúC√¢u 1.‚Äù, ‚ÄúC√¢u 2.‚Äù... Ph·∫ßn l·ª±a ch·ªçn
            (A., B., C., D.) b·∫°n c√≥ th·ªÉ ghi ·ªü d∆∞·ªõi, ho·∫∑c t√πy theo quy ∆∞·ªõc ri√™ng
            c·ªßa b·∫°n. Ph·∫ßn chuy·ªÉn ƒë·ªïi ch√≠nh x√°c b·∫°n c√≥ th·ªÉ ch·ªânh l·∫°i trong JS.
          </p>
        </div>

        <div style="margin-top:10px;">
          <label for="answerKeyP1">ƒê√°p √°n (1 d√≤ng / 1 c√¢u, v√≠ d·ª•: A, B, C, D,...)</label>
          <textarea
            id="answerKeyP1"
            class="builder-textarea"
            style="min-height:80px;"
            placeholder="1: A
2: C
3: B
..."
          ></textarea>
        </div>

        <div style="margin-top:10px; text-align:right;">
          <button id="btnBuildP1" type="button" class="main-btn">
            üß© T·∫°o JSON ph·∫ßn 1
          </button>
        </div>

        <div>
          <p class="json-output-title">JSON output (Ph·∫ßn 1)</p>
          <textarea
            id="jsonOutputP1"
            class="builder-textarea"
            style="min-height:140px;"
          ></textarea>
        </div>
      </div>

      <!-- C√°c panel c√≤n l·∫°i ch·ªâ ƒë·ªÉ placeholder. B·∫°n c√≥ th·ªÉ b·ªï sung logic sau. -->
      <div id="tab-mcqimg" class="builder-tab-panel">
        <h2 class="builder-section-title">Ph·∫ßn 2 ‚Äì MCQ + H√¨nh (placeholder)</h2>
        <p class="helper-note">
          B·∫°n c√≥ th·ªÉ copy c·∫•u tr√∫c c·ªßa Ph·∫ßn 1 v√† ƒëi·ªÅu ch·ªânh cho ki·ªÉu
          <code>mcqImage</code>.
        </p>
      </div>

      <div id="tab-readmcq" class="builder-tab-panel">
        <h2 class="builder-section-title">Ph·∫ßn 3 ‚Äì Reading MCQ (placeholder)</h2>
        <p class="helper-note">
          T∆∞∆°ng t·ª±, panel n√†y b·∫°n t·ª± tri·ªÉn khai cho ki·ªÉu
          <code>readingMcq</code>.
        </p>
      </div>

      <div id="tab-dragdrop" class="builder-tab-panel">
        <h2 class="builder-section-title">Ph·∫ßn 4 ‚Äì Drag &amp; Drop (placeholder)</h2>
        <p class="helper-note">
          Tri·ªÉn khai theo schema <code>readingDragDrop</code> b·∫°n ƒëang d√πng.
        </p>
      </div>

      <div id="tab-wordform" class="builder-tab-panel">
        <h2 class="builder-section-title">Ph·∫ßn 5 ‚Äì Word Form (placeholder)</h2>
        <p class="helper-note">
          Tri·ªÉn khai theo schema <code>wordForm</code>.
        </p>
      </div>

      <div id="tab-reorder" class="builder-tab-panel">
        <h2 class="builder-section-title">
          Ph·∫ßn 6 ‚Äì Reorder / Rewrite (placeholder)
        </h2>
        <p class="helper-note">
          Tri·ªÉn khai theo schema <code>reorderAndRewrite</code>.
        </p>
      </div>
    </div>
  </div>

  <!-- ================== JS ================== -->
  <script>
    // ---------- Tabs ----------
    document.addEventListener("DOMContentLoaded", () => {
      const tabButtons = document.querySelectorAll(".builder-tab-btn");
      const panels = document.querySelectorAll(".builder-tab-panel");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;
          tabButtons.forEach((b) => b.classList.remove("active"));
          panels.forEach((p) => p.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(target)?.classList.add("active");
        });
      });
    });

    // ---------- Manifest & section ID ----------
    let sectionManifest = null;

    async function loadSectionsManifest() {
      const statusEl = document.getElementById("manifestStatus");
      statusEl.textContent = "ƒêang t·∫£i manifest...";
      statusEl.style.color = "#4b5563";

      try {
        // ch·ªânh l·∫°i path n·∫øu b·∫°n ƒë·ªÉ ch·ªó kh√°c
        const res = await fetch("/content/sectionsManifest.json");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        sectionManifest = await res.json();
        const count = (sectionManifest.sections || []).length || 0;

        statusEl.style.color = "#15803d";
        statusEl.textContent = "ƒê√£ t·∫£i " + count + " section t·ª´ manifest.";

        document.getElementById("btnNewSection").disabled = false;
      } catch (err) {
        console.error("L·ªói load manifest:", err);
        sectionManifest = null;
        statusEl.style.color = "#b91c1c";
        statusEl.textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c manifest: " + err.message;
        document.getElementById("btnNewSection").disabled = true;
      }
    }

    function suggestNextSectionId() {
      if (!sectionManifest) {
        alert("B·∫°n c·∫ßn b·∫•m 'N·∫°p sectionsManifest.json' tr∆∞·ªõc ƒë√£.");
        return;
      }

      const testNameInput = document.getElementById("testName");
      const sectionIdInput = document.getElementById("sectionId");

      const rawTestName = (testNameInput?.value || "").trim();
      const baseId = rawTestName || "P1";
      // V√≠ d·ª•: prefix = "P1_"
      const prefix = baseId + "_";

      let maxNum = 0;
      const sections = sectionManifest.sections || [];

      sections.forEach((sec) => {
        if (!sec.id || typeof sec.id !== "string") return;
        if (!sec.id.startsWith(prefix)) return;

        const numStr = sec.id.slice(prefix.length);
        const num = parseInt(numStr, 10);
        if (!isNaN(num) && num > maxNum) {
          maxNum = num;
        }
      });

      const nextNum = maxNum + 1;
      const nextId = prefix + String(nextNum).padStart(3, "0");

      if (sectionIdInput) {
        sectionIdInput.value = nextId;
        sectionIdInput.focus();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const btnLoad = document.getElementById("btnLoadManifest");
      const btnNew = document.getElementById("btnNewSection");

      btnLoad?.addEventListener("click", loadSectionsManifest);
      btnNew?.addEventListener("click", suggestNextSectionId);
    });

    // ---------- Builder MCQ ƒë∆°n gi·∫£n cho Ph·∫ßn 1 ----------
    function parseAnswerKey(text) {
      // h·ªó tr·ª£ 2 d·∫°ng:
      //  A
      //  B
      //  C
      // ho·∫∑c 1: A; 2: C; ...
      const lines = text
        .split(/\r?\n/)
        .map((l) => l.trim())
        .filter((l) => l.length > 0);

      const answers = [];
      lines.forEach((line) => {
        const m = line.match(/^(\d+)\s*[:\-\.]\s*([A-D])$/i);
        if (m) {
          const idx = parseInt(m[1], 10);
          answers[idx - 1] = m[2].toUpperCase();
        } else if (/^[A-D]$/i.test(line)) {
          answers.push(line.toUpperCase());
        }
      });
      return answers;
    }

    function buildMcqJson() {
      const sectionId = document.getElementById("sectionId").value.trim();
      const sectionTitle = document
        .getElementById("sectionTitle")
        .value.trim();
      const raw = document.getElementById("rawP1").value;
      const answerKey = document.getElementById("answerKeyP1").value;

      if (!sectionId) {
        alert("B·∫°n ch∆∞a nh·∫≠p section.id");
        return;
      }

      // R·∫•t ƒë∆°n gi·∫£n: t√°ch c√°c d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng "C√¢u n."
      // B·∫°n c√≥ th·ªÉ thay b·∫±ng parser c≈© n·∫øu c·∫ßn ch√≠nh x√°c h∆°n.
      const qBlocks = raw
        .split(/\n(?=C√¢u\s*\d+\s*\.)/i)
        .map((b) => b.trim())
        .filter((b) => b.length > 0);

      const answers = parseAnswerKey(answerKey);

      const questions = qBlocks.map((block, idx) => {
        const num = idx + 1;
        const m = block.match(/^C√¢u\s*\d+\s*\.\s*(.+)$/i);
        const text = m ? m[1].trim() : block;

        // ·ªû ƒë√¢y m√¨nh ch·ªâ t·∫°o dummy 4 l·ª±a ch·ªçn (A,B,C,D) ‚Äì b·∫°n s·ª≠a l·∫°i cho ƒë√∫ng schema c≈© n·∫øu mu·ªën.
        const opts = ["A", "B", "C", "D"].map((label) => label + ".");
        const correctLetter = answers[idx] || "A";
        const correctIndex = { A: 0, B: 1, C: 2, D: 3 }[correctLetter] ?? 0;

        return {
          number: num,
          text,
          options: opts,
          correct: correctIndex,
        };
      });

      const section = {
        id: sectionId,
        type: "mcqOneByOne",
        title: sectionTitle || "Ph·∫ßn 1 ‚Äì Tr·∫Øc nghi·ªám",
        questions,
      };

      document.getElementById("jsonOutputP1").value = JSON.stringify(
        section,
        null,
        2
      );
    }

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("btnBuildP1")
        ?.addEventListener("click", buildMcqJson);
    });
  </script>
</body>
</html>
