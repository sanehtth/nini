<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Make JSON - Builder 6 ph·∫ßn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(135deg, #fecaca, #fee2e2, #fce7f3);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 24px 12px;
        color: #111827;
      }
      .page {
        width: 100%;
        max-width: 1040px;
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
        padding: 20px 22px 24px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 14px;
      }
      .page-title {
        font-size: 20px;
        font-weight: 700;
      }
      .page-subtitle {
        font-size: 13px;
        color: #6b7280;
      }
      .btn {
        border-radius: 999px;
        border: none;
        padding: 7px 16px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.05s ease,
          background 0.1s ease;
        white-space: nowrap;
      }
      .btn:active {
        transform: translateY(1px);
        box-shadow: none;
      }
      .main-btn {
        background: #ec4899;
        color: white;
        box-shadow: 0 10px 24px rgba(236, 72, 153, 0.4);
      }
      .main-btn:hover {
        background: #db2777;
      }
      .ghost {
        background: #f9fafb;
        color: #111827;
        border: 1px solid #e5e7eb;
      }
      .ghost:hover {
        background: #f3f4f6;
      }
      .danger {
        background: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
      }
      .danger:hover {
        background: #fecaca;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
      }
      .row.gap-8 {
        gap: 8px;
      }
      .row.gap-10 {
        gap: 10px;
      }
      .field {
        margin-bottom: 10px;
      }
      .field label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .input,
      textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #d4d4d8;
        padding: 7px 9px;
        font-size: 14px;
      }
      textarea {
        resize: vertical;
        min-height: 90px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 12px 0;
      }
      .tab-btn {
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        padding: 5px 14px;
        font-size: 13px;
        background: #f9fafb;
        cursor: pointer;
      }
      .tab-btn.active {
        background: #e11d48;
        color: #ffffff;
        border-color: #e11d48;
      }
      .section-card {
        border-radius: 18px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        padding: 16px 14px 16px;
        margin-top: 6px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .section-help {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 10px;
      }
      .output-box {
        margin-top: 10px;
        border-radius: 12px;
        background: #111827;
        color: #e5e7eb;
        padding: 10px 10px 8px;
        font-size: 12px;
      }
      .output-box pre {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 4px 0 0;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: #fef3c7;
        color: #92400e;
      }
      .manifest-status {
        font-size: 12px;
        color: #6b7280;
      }
      .manifest-status.ok {
        color: #16a34a;
      }
      .manifest-status.err {
        color: #b91c1c;
      }
      @media (max-width: 640px) {
        .page {
          padding: 16px 14px 18px;
        }
        .page-header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <!-- HEADER -->
      <div class="page-header">
        <div>
          <div class="page-title">Make JSON ‚Äì Builder 6 ph·∫ßn</div>
          <div class="page-subtitle">
            D√πng ƒë·ªÉ t·∫°o c√°c file section JSON & c·∫≠p nh·∫≠t manifest cho Ti·∫øng Anh.
          </div>
        </div>
        <div class="row gap-8">
          <button class="ghost btn" onclick="window.location.href='index.html'">
            ‚¨Ö V·ªÅ trang ch√≠nh
          </button>
        </div>
      </div>

      <!-- T√äN B√ÄI TEST & MANIFEST -->
      <div class="field">
        <label for="testName">T√™n b√†i test (testName)</label>
        <input
          id="testName"
          class="input"
          placeholder="vd: Test 1"
          autocomplete="off"
        />
        <div class="page-subtitle" style="margin-top: 4px">
          M·ªói section s·∫Ω c√≥ testName = gi√° tr·ªã n√†y, v√≠ d·ª• ‚ÄúTest1‚Äù. B·∫°n d√πng ƒë·ªÉ
          t·∫°o prefix ID: Test1_1, Test1_2, ...
        </div>
      </div>

      <div class="row gap-8" style="margin-bottom: 10px">
        <button id="btnLoadSectionsManifest" class="btn ghost">
          üì• N·∫°p sectionsManifest.json
        </button>
        <button id="btnSaveSectionsManifest" class="btn main-btn">
          üíæ C·∫≠p nh·∫≠t manifest l√™n GitHub
        </button>
        <button id="btnNewSectionMeta" class="btn ghost">
          ‚ûï T·∫°o section m·ªõi
        </button>
        <span id="manifestStatus" class="manifest-status">
          Ch∆∞a n·∫°p manifest.
        </span>
      </div>

      <div class="page-subtitle" id="sectionHint">
        ƒê√£ t·∫£i 0 section t·ª´ manifest.
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="p1">Ph·∫ßn 1 (MCQ)</button>
        <button class="tab-btn" data-tab="p2">Ph·∫ßn 2 (MCQ + h√¨nh)</button>
        <button class="tab-btn" data-tab="p3">Ph·∫ßn 3 (MCQ / reading)</button>
        <button class="tab-btn" data-tab="p4">Ph·∫ßn 4 (Drag & drop)</button>
        <button class="tab-btn" data-tab="p5">Ph·∫ßn 5 (Word form)</button>
        <button class="tab-btn" data-tab="p6">Ph·∫ßn 6 (Reorder / Rewrite)</button>
      </div>

      <!-- PH·∫¶N 1 -->
      <div class="section-card" data-panel="p1">
        <div class="section-title">
          Ph·∫ßn 1 ‚Äì Tr·∫Øc nghi·ªám (mcqOneByOne)
          <span class="pill">type: "mcqOneByOne"</span>
        </div>
        <p class="section-help">
          M·ªói c√¢u 4 ƒë√°p √°n A, B, C, D. B·∫°n nh·∫≠p n·ªôi dung th√¥, builder s·∫Ω sinh
          JSON cho ph·∫ßn n√†y.
        </p>

        <div class="row gap-10" style="margin-bottom: 10px">
          <div class="field" style="flex: 1 1 180px">
            <label for="p1_id">section.id (P1_001, P1_002,...)</label>
            <input
              id="p1_id"
              class="input"
              placeholder="vd: P1_001"
              autocomplete="off"
            />
          </div>
          <div class="field" style="flex: 2 1 260px">
            <label for="p1_title">section.title (n·∫øu ƒë·ªÉ tr·ªëng s·∫Ω t·ª± sinh)</label>
            <input
              id="p1_title"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 1 - Tr·∫Øc nghi·ªám"
            />
          </div>
        </div>

        <div class="field">
          <label for="p1_raw">N·ªôi dung th√¥ (c√¢u 1‚Äì14)</label>
          <textarea
            id="p1_raw"
            placeholder="C√¢u 1. ...
C√¢u 2. ...
C√¢u 3. ..."
          ></textarea>
          <div class="section-help">
            D√≤ng c√¢u h·ªèi d·∫°ng: <code>C√¢u 1. N·ªôi dung ...</code> M·ªói c√¢u 4 d√≤ng
            ƒë√°p √°n ngay sau: <code>A. ...</code>, <code>B. ...</code>, ...
          </div>
        </div>

        <div class="field">
          <label for="p1_answers"
            >ƒê√°p √°n (1 d√≤ng / 1 c√¢u, v√≠ d·ª•: A, B, C, D,...)</label
          >
          <textarea
            id="p1_answers"
            placeholder="1: A
2: C
3: B ..."
          ></textarea>
        </div>

        <button id="btnBuildP1" class="btn main-btn">
          ‚öôÔ∏è T·∫°o JSON ph·∫ßn 1
        </button>

        <div class="output-box">
          <div>JSON output (Ph·∫ßn 1)</div>
          <pre id="p1_output">// K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
      </div>

      <!-- PH·∫¶N 2 -->
      <div class="section-card" data-panel="p2" style="display: none">
        <div class="section-title">
          Ph·∫ßn 2 ‚Äì MCQ + H√¨nh (mcqImage)
          <span class="pill">type: "mcqImage"</span>
        </div>
        <p class="section-help">
          Phi√™n b·∫£n ƒë∆°n gi·∫£n: builder ch·ªâ ƒë√≥ng g√≥i d·ªØ li·ªáu th√¥, b·∫°n c√≥ th·ªÉ ch·ªânh
          tay th√™m <code>imageFile</code>, <code>options</code> sau.
        </p>

        <div class="row gap-10" style="margin-bottom: 10px">
          <div class="field" style="flex: 1 1 180px">
            <label for="p2_id">section.id</label>
            <input id="p2_id" class="input" placeholder="P2_001" />
          </div>
          <div class="field" style="flex: 2 1 260px">
            <label for="p2_title">section.title</label>
            <input
              id="p2_title"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 2 - MCQ h√¨nh"
            />
          </div>
        </div>

        <div class="field">
          <label for="p2_raw">N·ªôi dung th√¥</label>
          <textarea
            id="p2_raw"
            placeholder="B·∫°n c√≥ th·ªÉ ghi ch√∫ c·∫•u tr√∫c ·ªü ƒë√¢y..."
          ></textarea>
        </div>

        <button id="btnBuildP2" class="btn main-btn">
          ‚öôÔ∏è T·∫°o JSON ph·∫ßn 2 (th√¥)
        </button>

        <div class="output-box">
          <div>JSON output (Ph·∫ßn 2)</div>
          <pre id="p2_output">// K·∫øt qu·∫£ th√¥ s·∫Ω hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
      </div>

      <!-- PH·∫¶N 3 -->
      <div class="section-card" data-panel="p3" style="display: none">
        <div class="section-title">
          Ph·∫ßn 3 ‚Äì Reading MCQ (readingMcq)
          <span class="pill">type: "readingMcq"</span>
        </div>
        <p class="section-help">
          Builder ƒë√≥ng g√≥i passage + note, b·∫°n b·ªï sung chi ti·∫øt c√¢u h·ªèi sau.
        </p>

        <div class="row gap-10" style="margin-bottom: 10px">
          <div class="field" style="flex: 1 1 180px">
            <label for="p3_id">section.id</label>
            <input id="p3_id" class="input" placeholder="P3_001" />
          </div>
          <div class="field" style="flex: 2 1 260px">
            <label for="p3_title">section.title</label>
            <input
              id="p3_title"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 3 - ƒê·ªçc hi·ªÉu"
            />
          </div>
        </div>

        <div class="field">
          <label for="p3_passage">Passage</label>
          <textarea id="p3_passage" placeholder="ƒêo·∫°n vƒÉn..."></textarea>
        </div>

        <div class="field">
          <label for="p3_note">Ghi ch√∫ / c·∫•u tr√∫c c√¢u h·ªèi</label>
          <textarea
            id="p3_note"
            placeholder="B·∫°n m√¥ t·∫£ c√°ch chia c√¢u h·ªèi ·ªü ƒë√¢y..."
          ></textarea>
        </div>

        <button id="btnBuildP3" class="btn main-btn">
          ‚öôÔ∏è T·∫°o JSON ph·∫ßn 3 (th√¥)
        </button>

        <div class="output-box">
          <div>JSON output (Ph·∫ßn 3)</div>
          <pre id="p3_output">// K·∫øt qu·∫£ th√¥ s·∫Ω hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
      </div>

      <!-- PH·∫¶N 4 -->
      <div class="section-card" data-panel="p4" style="display: none">
        <div class="section-title">
          Ph·∫ßn 4 ‚Äì Drag & Drop (readingDragDrop)
          <span class="pill">type: "readingDragDrop"</span>
        </div>
        <p class="section-help">
          ƒê√°nh d·∫•u ch·ªó tr·ªëng b·∫±ng __1__, __2__... Builder ch·ªâ g√≥i passage +
          wordBank + blanks d·∫°ng text.
        </p>

        <div class="row gap-10" style="margin-bottom: 10px">
          <div class="field" style="flex: 1 1 180px">
            <label for="p4_id">section.id</label>
            <input id="p4_id" class="input" placeholder="P4_001" />
          </div>
          <div class="field" style="flex: 2 1 260px">
            <label for="p4_title">section.title</label>
            <input
              id="p4_title"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 4 - ƒêi·ªÅn t·ª´"
            />
          </div>
        </div>

        <div class="field">
          <label for="p4_passage">Passage (d√πng __1__, __2__ cho ch·ªó tr·ªëng)</label>
          <textarea id="p4_passage"></textarea>
        </div>

        <div class="field">
          <label for="p4_wordbank">WordBank (1 t·ª´ / d√≤ng)</label>
          <textarea
            id="p4_wordbank"
            placeholder="t·ª´1
t·ª´2
t·ª´3"
          ></textarea>
        </div>

        <div class="field">
          <label for="p4_blanks">ƒê√°p √°n blanks (1 d√≤ng: s·ªë: t·ª´)</label>
          <textarea
            id="p4_blanks"
            placeholder="1: t·ª´1
2: t·ª´2"
          ></textarea>
        </div>

        <button id="btnBuildP4" class="btn main-btn">
          ‚öôÔ∏è T·∫°o JSON ph·∫ßn 4
        </button>

        <div class="output-box">
          <div>JSON output (Ph·∫ßn 4)</div>
          <pre id="p4_output">// K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
      </div>

      <!-- PH·∫¶N 5 -->
      <div class="section-card" data-panel="p5" style="display: none">
        <div class="section-title">
          Ph·∫ßn 5 ‚Äì Word Form (wordForm)
          <span class="pill">type: "wordForm"</span>
        </div>
        <p class="section-help">
          M·ªói d√≤ng: c√¢u v·ªõi t·ª´ g·ªëc trong ngo·∫∑c vu√¥ng + ƒë√°p √°n. Builder g√≥i
          th√†nh list c√¢u.
        </p>

        <div class="row gap-10" style="margin-bottom: 10px">
          <div class="field" style="flex: 1 1 180px">
            <label for="p5_id">section.id</label>
            <input id="p5_id" class="input" placeholder="P5_001" />
          </div>
          <div class="field" style="flex: 2 1 260px">
            <label for="p5_title">section.title</label>
            <input
              id="p5_title"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 5 - Word form"
            />
          </div>
        </div>

        <div class="field">
          <label for="p5_raw">N·ªôi dung th√¥ (1 d√≤ng / 1 c√¢u)</label>
          <textarea
            id="p5_raw"
            placeholder="C√¢u 1 ... (WORD) ... | ƒë√°p √°n
C√¢u 2 ... (WORD) ... | ƒë√°p √°n"
          ></textarea>
        </div>

        <button id="btnBuildP5" class="btn main-btn">
          ‚öôÔ∏è T·∫°o JSON ph·∫ßn 5 (th√¥)
        </button>

        <div class="output-box">
          <div>JSON output (Ph·∫ßn 5)</div>
          <pre id="p5_output">// K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
      </div>

      <!-- PH·∫¶N 6 -->
      <div class="section-card" data-panel="p6" style="display: none">
        <div class="section-title">
          Ph·∫ßn 6 ‚Äì Reorder / Rewrite (reorderAndRewrite)
          <span class="pill">type: "reorderAndRewrite"</span>
        </div>
        <p class="section-help">
          B·∫°n c√≥ th·ªÉ nh·∫≠p t·ª´ng c√¢u, builder g√≥i th√†nh danh s√°ch ƒë·ªÉ d√πng trong
          quizEng.
        </p>

        <div class="row gap-10" style="margin-bottom: 10px">
          <div class="field" style="flex: 1 1 180px">
            <label for="p6_id">section.id</label>
            <input id="p6_id" class="input" placeholder="P6_001" />
          </div>
          <div class="field" style="flex: 2 1 260px">
            <label for="p6_title">section.title</label>
            <input
              id="p6_title"
              class="input"
              placeholder="vd: Test 1 - Ph·∫ßn 6 - Vi·∫øt l·∫°i c√¢u"
            />
          </div>
        </div>

        <div class="field">
          <label for="p6_raw">M·ªói d√≤ng 1 c√¢u (m√¥ t·∫£ | ƒë√°p √°n)</label>
          <textarea
            id="p6_raw"
            placeholder="S·∫Øp x·∫øp t·ª´: ... | c√¢u chu·∫©n
Vi·∫øt l·∫°i c√¢u: ... | c√¢u chu·∫©n"
          ></textarea>
        </div>

        <button id="btnBuildP6" class="btn main-btn">
          ‚öôÔ∏è T·∫°o JSON ph·∫ßn 6 (th√¥)
        </button>

        <div class="output-box">
          <div>JSON output (Ph·∫ßn 6)</div>
          <pre id="p6_output">// K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</pre>
        </div>
      </div>
    </div>

    <script>
      // ====== TAB ======
      const tabButtons = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll("[data-panel]");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          panels.forEach((p) => {
            p.style.display = p.dataset.panel === tab ? "block" : "none";
          });
        });
      });

      // ====== MANIFEST STATE ======
      const SECTIONS_MANIFEST_PUBLIC_PATH = "/content/sectionsManifest.json";
      const manifestStatusEl = document.getElementById("manifestStatus");
      const sectionHintEl = document.getElementById("sectionHint");
      const loadBtn = document.getElementById("btnLoadSectionsManifest");
      const saveBtn = document.getElementById("btnSaveSectionsManifest");
      const newSectionMetaBtn = document.getElementById("btnNewSectionMeta");
      const testNameInput = document.getElementById("testName");

      let currentSectionsManifest = { sections: [] };

      function setManifestStatus(text, type) {
        manifestStatusEl.textContent = text;
        manifestStatusEl.classList.remove("ok", "err");
        if (type === "ok") manifestStatusEl.classList.add("ok");
        if (type === "err") manifestStatusEl.classList.add("err");
      }

      async function loadSectionsManifest() {
        try {
          setManifestStatus("ƒêang n·∫°p sectionsManifest.json...", "");
          const res = await fetch(
            SECTIONS_MANIFEST_PUBLIC_PATH + "?v=" + Date.now()
          );
          if (!res.ok) throw new Error("HTTP " + res.status);
          const json = await res.json();
          currentSectionsManifest = json || { sections: [] };
          const len = currentSectionsManifest.sections
            ? currentSectionsManifest.sections.length
            : 0;
          setManifestStatus("ƒê√£ n·∫°p manifest (" + len + " section).", "ok");
          sectionHintEl.textContent =
            "ƒê√£ t·∫£i " + len + " section t·ª´ manifest hi·ªán t·∫°i.";
        } catch (e) {
          console.error(e);
          setManifestStatus("L·ªói n·∫°p manifest: " + e.message, "err");
        }
      }

      async function saveSectionsManifestToGitHub() {
        try {
          if (
            !currentSectionsManifest ||
            !Array.isArray(currentSectionsManifest.sections)
          ) {
            alert(
              "Ch∆∞a c√≥ d·ªØ li·ªáu manifest h·ª£p l·ªá. H√£y b·∫•m ‚ÄúN·∫°p sectionsManifest.json‚Äù tr∆∞·ªõc."
            );
            return;
          }

          setManifestStatus("ƒêang g·ª≠i manifest l√™n GitHub...", "");
          saveBtn.disabled = true;

          const res = await fetch("/api/updateSectionsManifest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: "public/content/sectionsManifest.json",
              contentJson: currentSectionsManifest,
              message: "Update sectionsManifest from makejson.html",
            }),
          });

          const data = await res.json();
          if (!res.ok || !data.ok) {
            console.error("saveSectionsManifest error:", data);
            setManifestStatus(
              "L·ªói c·∫≠p nh·∫≠t GitHub: " + (data.error || res.status),
              "err"
            );
            alert(
              "L∆∞u l√™n GitHub th·∫•t b·∫°i.\n" + (data.detail || data.error || "")
            );
          } else {
            setManifestStatus(
              "ƒê√£ c·∫≠p nh·∫≠t manifest l√™n GitHub (commit " +
                data.commit.slice(0, 7) +
                "‚Ä¶).",
              "ok"
            );
            alert("ƒê√£ l∆∞u sectionsManifest.json l√™n GitHub!");
          }
        } catch (e) {
          console.error(e);
          setManifestStatus("L·ªói m·∫°ng khi g·ªçi API.", "err");
          alert("C√≥ l·ªói m·∫°ng khi g·ªçi API: " + e.message);
        } finally {
          saveBtn.disabled = false;
        }
      }

      function slugify(str) {
        return (str || "")
          .toString()
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "")
          .substring(0, 40);
      }

      function getActiveSectionMeta() {
        const activeTab = document.querySelector(".tab-btn.active")?.dataset
          .tab;
        if (!activeTab) return null;

        const perTest = testNameInput.value.trim() || "testX";

        switch (activeTab) {
          case "p1":
            return {
              id: document.getElementById("p1_id").value.trim() || "P1_001",
              title:
                document.getElementById("p1_title").value.trim() ||
                "Ph·∫ßn 1 - MCQ",
              type: "mcqOneByOne",
              testName: perTest,
            };
          case "p2":
            return {
              id: document.getElementById("p2_id").value.trim() || "P2_001",
              title:
                document.getElementById("p2_title").value.trim() ||
                "Ph·∫ßn 2 - MCQ h√¨nh",
              type: "mcqImage",
              testName: perTest,
            };
          case "p3":
            return {
              id: document.getElementById("p3_id").value.trim() || "P3_001",
              title:
                document.getElementById("p3_title").value.trim() ||
                "Ph·∫ßn 3 - Reading",
              type: "readingMcq",
              testName: perTest,
            };
          case "p4":
            return {
              id: document.getElementById("p4_id").value.trim() || "P4_001",
              title:
                document.getElementById("p4_title").value.trim() ||
                "Ph·∫ßn 4 - DragDrop",
              type: "readingDragDrop",
              testName: perTest,
            };
          case "p5":
            return {
              id: document.getElementById("p5_id").value.trim() || "P5_001",
              title:
                document.getElementById("p5_title").value.trim() ||
                "Ph·∫ßn 5 - WordForm",
              type: "wordForm",
              testName: perTest,
            };
          case "p6":
            return {
              id: document.getElementById("p6_id").value.trim() || "P6_001",
              title:
                document.getElementById("p6_title").value.trim() ||
                "Ph·∫ßn 6 - Reorder",
              type: "reorderAndRewrite",
              testName: perTest,
            };
          default:
            return null;
        }
      }

      function handleAddSectionMeta() {
        if (!currentSectionsManifest.sections) {
          currentSectionsManifest.sections = [];
        }
        const meta = getActiveSectionMeta();
        if (!meta) {
          alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ph·∫ßn ƒëang ch·ªçn.");
          return;
        }
        const slug = slugify(meta.testName);
        const filePath = `/content/${slug}/${meta.id}.json`;

        const entry = {
          id: meta.id,
          title: meta.title,
          type: meta.type,
          testName: meta.testName,
          file: filePath,
        };

        currentSectionsManifest.sections.push(entry);
        const len = currentSectionsManifest.sections.length;
        sectionHintEl.textContent =
          "ƒê√£ th√™m section " + meta.id + " (" + len + " m·ª•c trong manifest).";

        setManifestStatus(
          "ƒê√£ th√™m meta m·ªõi (ch∆∞a l∆∞u l√™n GitHub).",
          "ok"
        );
        console.log("currentSectionsManifest", currentSectionsManifest);
      }

      if (loadBtn) loadBtn.onclick = loadSectionsManifest;
      if (saveBtn) saveBtn.onclick = saveSectionsManifestToGitHub;
      if (newSectionMetaBtn) newSectionMetaBtn.onclick = handleAddSectionMeta;

      // ====== BUILDER PH·∫¶N 1 ‚Äì MCQ ======
      function parseAnswers(text) {
        const result = {};
        const lines = (text || "")
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);
        lines.forEach((line) => {
          const m = line.match(/^(\d+)\s*[:\-]?\s*([A-D])/i);
          if (m) {
            result[m[1]] = m[2].toUpperCase();
          }
        });
        return result;
      }

      function buildP1() {
        const sectionId =
          document.getElementById("p1_id").value.trim() || "P1_001";
        const sectionTitle =
          document.getElementById("p1_title").value.trim() ||
          "Ph·∫ßn 1 - Tr·∫Øc nghi·ªám";
        const raw = document.getElementById("p1_raw").value || "";
        const answerText = document.getElementById("p1_answers").value || "";
        const outEl = document.getElementById("p1_output");

        // t√°ch d√≤ng
        const lines = raw.split("\n");
        const questions = [];
        let i = 0;
        let qNumber = 0;

        while (i < lines.length) {
          let line = lines[i].trim();
          if (!line) {
            i++;
            continue;
          }
          const m = line.match(/^C√¢u\s+(\d+)\.\s*(.+)$/i);
          if (!m) {
            i++;
            continue;
          }
          qNumber++;
          const number = parseInt(m[1], 10);
          const text = m[2].trim();

          const opts = [];
          for (let k = 0; k < 4 && i + 1 + k < lines.length; k++) {
            const optLine = lines[i + 1 + k].trim();
            const mo = optLine.match(/^([A-D])\.\s*(.+)$/i);
            if (mo) {
              opts.push(mo[2].trim());
            }
          }
          i += 1 + opts.length;

          if (opts.length < 2) continue;

          questions.push({
            number: number,
            text: text,
            options: opts,
          });
        }

        const ansMap = parseAnswers(answerText);
        questions.forEach((q) => {
          const key = String(q.number);
          const ansLetter = ansMap[key];
          if (!ansLetter) return;
          const index = { A: 0, B: 1, C: 2, D: 3 }[ansLetter];
          if (index != null) q.correct = index;
        });

        const sectionJson = {
          id: sectionId,
          type: "mcqOneByOne",
          title: sectionTitle,
          questions,
        };

        outEl.textContent = JSON.stringify(sectionJson, null, 2);
      }

      document.getElementById("btnBuildP1").onclick = buildP1;

      // ====== PH·∫¶N 2‚Äì6: builder ƒë∆°n gi·∫£n g√≥i th√¥ ======
      document.getElementById("btnBuildP2").onclick = () => {
        const obj = {
          id: document.getElementById("p2_id").value.trim() || "P2_001",
          type: "mcqImage",
          title:
            document.getElementById("p2_title").value.trim() ||
            "Ph·∫ßn 2 - MCQ h√¨nh",
          note: document.getElementById("p2_raw").value || "",
        };
        document.getElementById("p2_output").textContent = JSON.stringify(
          obj,
          null,
          2
        );
      };

      document.getElementById("btnBuildP3").onclick = () => {
        const obj = {
          id: document.getElementById("p3_id").value.trim() || "P3_001",
          type: "readingMcq",
          title:
            document.getElementById("p3_title").value.trim() ||
            "Ph·∫ßn 3 - Reading",
          passage: document.getElementById("p3_passage").value || "",
          note: document.getElementById("p3_note").value || "",
          questions: [],
        };
        document.getElementById("p3_output").textContent = JSON.stringify(
          obj,
          null,
          2
        );
      };

      document.getElementById("btnBuildP4").onclick = () => {
        const blanks = {};
        (document.getElementById("p4_blanks").value || "")
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean)
          .forEach((line) => {
            const m = line.match(/^(\d+)\s*[:\-]?\s*(.+)$/);
            if (m) blanks[m[1]] = m[2].trim();
          });

        const obj = {
          id: document.getElementById("p4_id").value.trim() || "P4_001",
          type: "readingDragDrop",
          title:
            document.getElementById("p4_title").value.trim() ||
            "Ph·∫ßn 4 - ƒêi·ªÅn t·ª´",
          passage: document.getElementById("p4_passage").value || "",
          wordBank: (document.getElementById("p4_wordbank").value || "")
            .split("\n")
            .map((l) => l.trim())
            .filter(Boolean),
          blanks,
        };
        document.getElementById("p4_output").textContent = JSON.stringify(
          obj,
          null,
          2
        );
      };

      document.getElementById("btnBuildP5").onclick = () => {
        const lines = (document.getElementById("p5_raw").value || "")
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);
        const questions = lines.map((line, idx) => {
          const parts = line.split("|");
          return {
            number: idx + 1,
            raw: parts[0].trim(),
            answer: (parts[1] || "").trim(),
          };
        });
        const obj = {
          id: document.getElementById("p5_id").value.trim() || "P5_001",
          type: "wordForm",
          title:
            document.getElementById("p5_title").value.trim() ||
            "Ph·∫ßn 5 - WordForm",
          questions,
        };
        document.getElementById("p5_output").textContent = JSON.stringify(
          obj,
          null,
          2
        );
      };

      document.getElementById("btnBuildP6").onclick = () => {
        const lines = (document.getElementById("p6_raw").value || "")
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);
        const items = lines.map((line, idx) => {
          const parts = line.split("|");
          return {
            number: idx + 1,
            prompt: parts[0].trim(),
            answer: (parts[1] || "").trim(),
          };
        });
        const obj = {
          id: document.getElementById("p6_id").value.trim() || "P6_001",
          type: "reorderAndRewrite",
          title:
            document.getElementById("p6_title").value.trim() ||
            "Ph·∫ßn 6 - Reorder",
          questions: items,
        };
        document.getElementById("p6_output").textContent = JSON.stringify(
          obj,
          null,
          2
        );
      };
    </script>
  </body>
</html>
