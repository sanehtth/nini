<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XNC - Tách scene & thoại</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; background:#d9efb9; }
    .topbar { display:flex; gap:8px; margin-bottom:12px; }
    .btn { padding:8px 10px; border:1px solid #333; border-radius:6px; background:#fff; cursor:pointer; }
    .btn.primary { background:#0b1320; color:#fff; border-color:#0b1320; }
    .btn.danger { background:#b30000; color:#fff; border-color:#b30000; }
    .grid { display:grid; grid-template-columns: 420px 1fr; gap: 12px; align-items:start; }
    .card { background:#fff; border:1px solid #b5caa2; border-radius:10px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap; }
    label { font-size: 13px; color:#222; }
    input[type="text"], textarea, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    textarea { min-height: 150px; }
    .muted { color:#666; font-size:12px; }
    .participants { margin-top:8px; }
    .participants .char-row { display:flex; gap:10px; align-items:center; padding:10px; border:1px solid #e6e6e6; border-radius:10px; margin:8px 0; }
    .participants .char-row.checked { outline:2px solid #22c55e; }
    .participants b { min-width: 120px; }
    .split { margin-top:12px; }
    pre { background:#0b1320; color:#fff; padding:12px; border-radius:10px; overflow:auto; }
    details { background:#f6f6f6; border:1px solid #e6e6e6; border-radius:10px; padding:8px; margin-top:8px; }
    summary { cursor:pointer; }
    .scene-list .scene-item { border:1px solid #e6e6e6; border-radius:10px; padding:10px; margin:10px 0; }
    .scene-item .head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .scene-item .title { font-weight:700; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fafafa; }
    .editor { border:2px solid #c6d9f5; border-radius:12px; padding:10px; margin-top:10px; background:#f9fbff; }
    .editor .head { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .editor textarea { min-height: 60px; }
  </style>
</head>

<body>
  <div class="topbar">
    <button class="btn primary" id="btnTab1">Tách scene & thoại</button>
    <button class="btn" id="btnTab2">Tạo prompt video</button>
  </div>

  <!-- TAB 1 -->
  <section id="tab1" class="card">
    <h2 style="margin:0 0 8px 0;">Tách scene & thoại (Tab 1)</h2>

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label><b>Chọn truyện từ JSON (substance manifest)</b></label>
        <select id="storySelect">
          <option value="">-- Chọn truyện --</option>
        </select>
        <div class="muted" id="manifestStatus">Manifest: chưa load</div>
      </div>

      <div class="row" style="margin-top:18px;">
        <button class="btn" id="btnReloadManifest">Reload manifest</button>
        <button class="btn primary" id="btnLoadStory">Load truyện</button>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <label><b>ID câu chuyện</b></label>
        <input id="storyId" type="text" placeholder="VD: XNC-20250110-112841" />

        <div style="height:8px"></div>

        <label><b>Tên câu chuyện</b></label>
        <input id="storyTitle" type="text" placeholder="VD: Bài kiểm tra cuối kỳ" />

        <div style="height:8px"></div>

        <label><b>Nội dung</b></label>
        <textarea id="storyText" placeholder="Dán story text hoặc load từ manifest..."></textarea>

        <div class="split">
          <label><b>Nhân vật tham gia</b> <span class="muted">(chọn để map thoại tốt hơn)</span></label>
          <input id="participantsSearch" type="text" placeholder="Tìm nhân vật..." />
          <div class="row">
            <button class="btn" id="btnPickAll">Chọn tất cả</button>
            <button class="btn" id="btnPickNone">Bỏ chọn</button>
            <span class="muted" id="participantsCount">Đã chọn: 0</span>
          </div>
          <div id="participantsBox" class="participants"></div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnSaveLocal">Lưu story (local)</button>
          <button class="btn" id="btnExportStory">Xuất JSON story</button>
          <button class="btn primary" id="btnSplit">Tách Scene & Thoại</button>
          <button class="btn" id="btnExportDialogue">Export JSON thoại</button>
          <button class="btn danger" id="btnClearPreview">Xóa preview</button>
        </div>
      </div>

      <div class="card">
        <label><b>Preview / JSON output</b></label>
        <pre id="preview">{}</pre>

        <div style="height:10px"></div>

        <h3 style="margin:10px 0 8px 0;">Scene manifest (sau khi tách)</h3>

        <!-- Editor header -->
        <div class="editor">
          <div class="head">
            <div>
              <span class="pill" id="activeLabel">Chưa có Scene</span>
            </div>
            <div class="row" style="margin:0;">
              <button class="btn" id="btnPrevScene">← Scene trước</button>
              <button class="btn" id="btnNextScene">Scene sau →</button>
            </div>
          </div>

          <div class="row">
            <div style="flex:1; min-width:240px;">
              <label>Chọn Scene</label>
              <select id="sceneSelect">
                <option value="">--</option>
              </select>
            </div>
            <div style="flex:1; min-width:240px;">
              <label>Chọn Frame</label>
              <select id="frameSelect">
                <option value="">--</option>
              </select>
            </div>
            <div style="flex:1; min-width:240px;">
              <label>Mode</label>
              <select id="modeSelect">
                <option value="dialogue">Dialogue (2 người/1 khung)</option>
                <option value="closeup">Close-up (1 người/khung)</option>
                <option value="hybrid">Hybrid</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div style="flex:1;">
              <label>Ghi chú Scene (để bạn nhớ đang làm gì)</label>
              <textarea id="sceneNote" placeholder="VD: Mục tiêu cảnh, cảm xúc chính, nhịp kể, điểm nhấn..."></textarea>
            </div>
            <div style="flex:1;">
              <label>Ghi chú Frame (shot hiện tại trong Scene)</label>
              <textarea id="frameNote" placeholder="VD: Shot cận/xa, ai là focus, hành động nhỏ, biểu cảm, ý đồ..."></textarea>
            </div>
          </div>
        </div>

        <div id="sceneList" class="scene-list"></div>
      </div>
    </div>
  </section>

  <!-- TAB 2 placeholder -->
  <section id="tab2" class="card" style="display:none;">
    <h2 style="margin:0 0 8px 0;">Tạo prompt video (Tab 2)</h2>
    <div class="muted">Tab 2 bạn đang dùng bản khác rồi; v14 tập trung làm sạch Tab 1 trước (tách scene + thoại + manifest).</div>
  </section>

  <script src="/js/make_video_bieucam.js"></script>
</body>
</html>
