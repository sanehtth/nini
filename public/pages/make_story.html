<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XNC Story Engine (Dynamic DNA)</title>
    <link rel="stylesheet" href="/public/style.css">
    <link rel="stylesheet" href="/public/green-theme.css">
    
    <style>
        /* GI·ªÆ THEME DNA */
        body {
            background: linear-gradient(135deg, #CDECC1 0%, #F4E8A2 100%);
            font-family: 'Segoe UI', sans-serif;
            color: #5D4037;
            padding: 20px;
        }

        .studio-card {
            background: rgba(255, 255, 255, 0.98);
            max-width: 1300px;
            margin: 0 auto;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(139, 94, 60, 0.15);
            border: 4px solid #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 85vh;
        }

        .studio-header {
            background: #8CCB7A; padding: 15px 30px; color: white;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 5px solid #B9885D;
        }

        /* THANH C√îNG C·ª§ TR√äN C√ôNG */
        .toolbar {
            background: #FFF8E1; padding: 15px 30px; border-bottom: 1px solid #FFE0B2;
            display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
        }

        .select-box {
            padding: 10px 15px; border-radius: 8px; border: 1px solid #FFB74D; 
            background: white; color: #E65100; font-weight: bold; cursor: pointer; outline: none; min-width: 200px;
        }

        /* INPUT AREA */
        .studio-body { padding: 25px; display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; flex-grow: 1; }

        .label-dna { color: #8CCB7A; font-weight: 800; margin-bottom: 8px; display: block; text-transform: uppercase; font-size: 13px; }
        
        .input-dna {
            width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 12px; background: #FAFAFA; margin-bottom: 15px; box-sizing: border-box;
        }
        .input-dna:focus { border-color: #8CCB7A; outline: none; background: white; }

        /* DANH S√ÅCH DI·ªÑN VI√äN */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto; padding: 10px; background: #F1F8E9; border-radius: 12px; border: 1px dashed #8CCB7A; }
        .char-item { font-size: 13px; background: white; padding: 8px; border-radius: 8px; border: 1px solid #ddd; display: flex; gap: 8px; align-items: center; cursor: pointer; }
        
        /* STYLE CARD (HI·ªÇN TH·ªä INFO DNA) */
        .dna-info-box {
            background: #E1F5FE; border: 1px solid #81D4FA; color: #0277BD; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; font-style: italic;
        }

        .btn-generate {
            background: linear-gradient(135deg, #B9885D, #8D6E63); color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; transition: 0.2s; box-shadow: 0 6px 0 #5D4037;
        }
        .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 8px 0 #5D4037; }
        .btn-generate:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        /* K·∫æT QU·∫¢ */
        .result-container {
            background: #FFFDE7; border: 2px dashed #FBC02D; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; position: relative;
        }
        .story-content {
            flex-grow: 1; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; line-height: 1.6; font-size: 15px; color: #3E2723; overflow-y: auto; max-height: 600px; padding-right: 10px;
        }

        .loading-spinner { display: none; text-align: center; margin-top: 50px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8CCB7A; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="studio-card">
    <div class="studio-header">
        <div class="header-left">
            <h2 style="margin:0">üß¨ XNC Story Engine V14</h2>
            <p style="margin:0; font-size:13px; opacity:0.9">H·ªá th·ªëng t·∫°o c·ªët truy·ªán ƒëa DNA</p>
        </div>
        <div style="background:#ffffff33; padding:5px 15px; border-radius:20px; font-size:12px;">Admin Mode</div>
    </div>

    <div class="toolbar">
        <div>
            <label style="font-size:12px; font-weight:bold; color:#B9885D; display:block; margin-bottom:5px;">1. CH·ªåN TR√ç TU·ªÜ (AI MODEL)</label>
            <select id="aiProvider" class="select-box" onchange="checkKeyStatus()">
                <option value="gemini">Google AI (Gemini Flash)</option>
                <option value="openai">OpenAI (GPT-4o)</option>
                <option value="grok">Grok (xAI)</option>
            </select>
        </div>

        <div>
            <label style="font-size:12px; font-weight:bold; color:#B9885D; display:block; margin-bottom:5px;">2. CH·ªåN H·ªÜ DNA (NARRATIVE STYLE)</label>
            <select id="dnaSelector" class="select-box" onchange="updateDNAInfo()">
                </select>
        </div>
        
        <div id="keyStatus" style="font-size:13px; margin-top:15px; margin-left:auto;"></div>
    </div>

    <div class="studio-body">
        <div>
            <div id="dnaInfo" class="dna-info-box">
                ƒêang t·∫£i DNA...
            </div>

            <label class="label-dna">3. √ù T∆∞·ªüng / C·ªët Truy·ªán</label>
            <textarea id="storyIdea" class="input-dna" rows="4" placeholder="Nh·∫≠p √Ω t∆∞·ªüng th√¥ v√†o ƒë√¢y (Vd: T√πmLa b·ªã m·∫•t c√°i n∆°...)"></textarea>

            <label class="label-dna">4. Di·ªÖn Vi√™n (Load t·ª´ JSON)</label>
            <div id="charList" class="char-grid">Loading...</div>

            <button id="btnGen" class="btn-generate" onclick="generateStory()">‚ú® VI·∫æT K·ªäCH B·∫¢N THEO DNA N√ÄY</button>
        </div>

        <div class="result-container">
            <div id="loading" class="loading-spinner">
                <div class="spinner"></div>
                <div id="loadingText" style="color:#8CCB7A; font-weight:bold;">AI ƒëang x·ª≠ l√Ω...</div>
            </div>
            
            <div id="finalStory" class="story-content">
                <div style="text-align:center; color:#999; margin-top:100px; font-style:italic;">
                    (Ch·ªçn DNA, nh·∫≠p √Ω t∆∞·ªüng v√† b·∫•m n√∫t ƒë·ªÉ xem ph√©p m√†u...)
                </div>
            </div>
            <button onclick="copyStory()" style="position:absolute; top:10px; right:10px; background:white; border:1px solid #ccc; padding:6px 12px; border-radius:8px; cursor:pointer;">üìã Copy</button>
        </div>
    </div>
</div>

<script>
    // === C·∫§U H√åNH DATA ===
    const DATA_PATH = "/public/adn/xomnganchuyen/"; 
    const CHAR_URL = DATA_PATH + "XNC_characters.json";
    
    // === C·∫§U H√åNH API KEY (L·∫•y t·ª´ localStorage) ===
    const ACTIVE_PROVIDER_KEY = "nini_active_provider";
    const PROFILE_ID = "default"; 

    function getActiveProvider() { return localStorage.getItem(ACTIVE_PROVIDER_KEY) || "gemini"; }
    function setActiveProvider(p) { localStorage.setItem(ACTIVE_PROVIDER_KEY, p); }
    function getApiKeyByProvider(provider) {
        const k1 = `lq_api_${PROFILE_ID}_${provider}`;
        return { key: localStorage.getItem(k1), keyName: k1 };
    }

    // === QUAN TR·ªåNG: KHO D·ªÆ LI·ªÜU DNA (NARRATIVE STYLES) ===
    // B·∫°n c√≥ th·ªÉ "g·∫Øn" th√™m bao nhi√™u DNA t√πy th√≠ch v√†o ƒë√¢y
    const DNA_STYLES = {
        "xnc_funny": {
            label: "üòÇ XNC: B√† T√°m Radio (H√†i)",
            desc: "·ªín √†o, tranh lu·∫≠n, gi·ªçng ƒëi·ªáu ch√¢m bi·∫øm nh·∫π nh√†ng, ƒë·∫≠m ch·∫•t mi·ªÅn T√¢y s√¥ng n∆∞·ªõc.",
            prompt: "STYLE: 'B√† T√°m Radio'. H√†i h∆∞·ªõc, nh√¢n v·∫≠t hay ng·∫Øt l·ªùi nhau. Ng√¥n ng·ªØ: Mi·ªÅn T√¢y Nam B·ªô (h√®n chi, tr·ªùi ƒë·∫•t, nghen)."
        },
        "xnc_spooky": {
            label: "üëª XNC: Chuy·ªán ƒê√™m Khuya (Ma)",
            desc: "Ma m·ªã nh∆∞ng ·∫•m c√∫ng. T·∫≠p trung v√†o √¢m thanh ƒë√™m. Kh√¥ng kinh d·ªã m√°u me.",
            prompt: "STYLE: 'Spooky but Cozy'. B√≠ ·∫©n, k·ªÉ chuy·ªán ƒë√™m khuya. Nh·∫•n m·∫°nh √¢m thanh m√¥i tr∆∞·ªùng [SFX]. Gi·ªçng k·ªÉ tr·∫ßm ·∫•m."
        },
        "xnc_emotional": {
            label: "ü•∫ XNC: T√¢m T√¨nh (C·∫£m ƒë·ªông)",
            desc: "S√¢u l·∫Øng, b√†i h·ªçc nh√¢n vƒÉn, t√¨nh l√†ng nghƒ©a x√≥m.",
            prompt: "STYLE: Emotional & Heartwarming. Nh·ªãp ƒëi·ªáu ch·∫≠m, t·∫≠p trung v√†o c·∫£m x√∫c n·ªôi t√¢m v√† t√¨nh c·∫£m gia ƒë√¨nh/b·∫°n b√®."
        },
        "vlog_daily": {
            label: "üìπ Vlog ƒê·ªùi S·ªëng (Review)",
            desc: "Phong c√°ch YouTuber/TikToker. N√≥i tr·ª±c ti·∫øp v·ªõi kh√°n gi·∫£.",
            prompt: "STYLE: Vlog/Review. Nh√¢n v·∫≠t ph√° v·ª° b·ª©c t∆∞·ªùng th·ª© 4 (Break 4th wall), n√≥i chuy·ªán tr·ª±c ti·∫øp v·ªõi camera/kh√°n gi·∫£. Ng√¥n ng·ªØ Gen Z."
        }
    };

    let charData = [];

    window.onload = async () => {
        // 1. Setup API Selector
        const sel = document.getElementById('aiProvider');
        if (sel) sel.value = getActiveProvider();
        checkKeyStatus();

        // 2. Setup DNA Selector
        renderDNASelector();

        // 3. Load Characters
        try {
            const res = await fetch(CHAR_URL);
            if(res.ok) {
                charData = (await res.json()).characters || [];
                renderChars();
            }
        } catch (e) { console.error(e); }
    };

    function renderDNASelector() {
        const sel = document.getElementById('dnaSelector');
        sel.innerHTML = "";
        for (const [key, val] of Object.entries(DNA_STYLES)) {
            const opt = document.createElement('option');
            opt.value = key;
            opt.text = val.label;
            sel.appendChild(opt);
        }
        updateDNAInfo(); // C·∫≠p nh·∫≠t th√¥ng tin l·∫ßn ƒë·∫ßu
    }

    function updateDNAInfo() {
        const key = document.getElementById('dnaSelector').value;
        const dna = DNA_STYLES[key];
        document.getElementById('dnaInfo').innerHTML = `
            <strong>M√¥ t·∫£ DNA:</strong> ${dna.desc}
        `;
    }

    function checkKeyStatus() {
        const provider = document.getElementById('aiProvider').value;
        setActiveProvider(provider);
        const { key, keyName } = getApiKeyByProvider(provider);
        const statusDiv = document.getElementById('keyStatus');
        
        if (key) {
            statusDiv.innerHTML = `‚úÖ Ready: <b>${keyName}</b>`;
            statusDiv.style.color = "#33691E";
        } else {
            statusDiv.innerHTML = `‚ö†Ô∏è Missing Key: <b>${keyName}</b>`;
            statusDiv.style.color = "#C62828";
        }
    }

    function renderChars() {
        const container = document.getElementById('charList');
        container.innerHTML = '';
        charData.forEach(c => {
            container.innerHTML += `
                <label class="char-item">
                    <input type="checkbox" value="${c.name}" data-desc="${c.personality || c.base_desc_en}">
                    <span style="font-weight:bold;">${c.name}</span>
                </label>`;
        });
    }

    async function generateStory() {
        const provider = document.getElementById('aiProvider').value;
        const { key: apiKey } = getApiKeyByProvider(provider);
        const storyIdea = document.getElementById('storyIdea').value;
        const dnaKey = document.getElementById('dnaSelector').value;
        
        if(!apiKey) { alert("Ch∆∞a c√≥ API Key!"); return; }
        if(!storyIdea) { alert("Nh·∫≠p √Ω t∆∞·ªüng ƒëi b·∫°n!"); return; }

        let selectedChars = [];
        document.querySelectorAll('#charList input:checked').forEach(cb => {
            selectedChars.push(`- ${cb.value}: ${cb.dataset.desc}`);
        });
        if(selectedChars.length === 0) { alert("Ch·ªçn di·ªÖn vi√™n!"); return; }

        // --- L·∫§Y DNA T·ª™ C·∫§U H√åNH ---
        const selectedDNA = DNA_STYLES[dnaKey];

        const btn = document.getElementById('btnGen');
        btn.disabled = true;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('finalStory').style.display = 'none';

        const systemPrompt = `
        ACT AS A SCREENWRITER.
        
        INPUT DATA:
        - Idea: ${storyIdea}
        - Characters: \n${selectedChars.join('\n')}
        
        REQUIRED DNA / STYLE:
        ${selectedDNA.prompt}

        TASK: Write a Dialogue Script based on the DNA above.
        - Language: Vietnamese.
        - Format: Standard Script ([Character]: Dialogue).
        - Include [SFX] and (Emotion).
        - Length: Short (approx 2-3 minutes).
        `;

        try {
            let resultText = "";
            if (provider === 'gemini') {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                resultText = data.candidates[0].content.parts[0].text;
            } else if (provider === 'openai' || provider === 'grok') {
                const endpoint = provider === 'openai' ? 'https://api.openai.com/v1/chat/completions' : 'https://api.x.ai/v1/chat/completions'; 
                const model = provider === 'openai' ? 'gpt-4o-mini' : 'grok-beta';
                const response = await fetch(endpoint, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: [{ role: "user", content: systemPrompt }], temperature: 0.7 })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                resultText = data.choices[0].message.content;
            }
            document.getElementById('finalStory').innerText = resultText;
        } catch (error) {
            alert("L·ªói: " + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('finalStory').style.display = 'block';
            btn.disabled = false;
        }
    }

    function copyStory() {
        navigator.clipboard.writeText(document.getElementById('finalStory').innerText);
        alert("ƒê√£ copy!");
    }
</script>

</body>
</html>
