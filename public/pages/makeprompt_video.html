<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Prompt t·∫°o VIDEO ‚Äì X√≥m Ng√†n Chuy·ªán</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS chung -->
  <link rel="stylesheet" href="/public/style.css" />
  <!-- Theme xanh l√° & n√¢u -->
  <link rel="stylesheet" href="/public/green-theme.css" />

 <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .xnc-page {
      max-width: 1100px; /* TƒÉng chi·ªÅu r·ªông m·ªôt ch√∫t ƒë·ªÉ chia c·ªôt ƒë·∫πp h∆°n */
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    /* Chia b·ªë c·ª•c ch√≠nh th√†nh 2 c·ªôt */
    .xnc-grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Chia 2 c·ªôt b·∫±ng nhau */
      gap: 16px;
      align-items: start;
    }
    /* C·ªôt b√™n ph·∫£i ch·ª©a c√°c √¥ Output (th∆∞·ªùng d√†i h∆°n) */
    .xnc-column-output {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .xnc-header { margin-bottom: 20px; }
    .xnc-header h1 { margin: 0 0 4px; font-size: 24px; }
    
    .xnc-block {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }
    .xnc-block h3 { margin-top: 0; margin-bottom: 8px; font-size: 16px; }
    .xnc-field { margin-bottom: 10px; }
    .xnc-field label { display: block; font-size: 13px; margin-bottom: 4px; font-weight: 500; }
    .xnc-field input, .xnc-field textarea, .xnc-field select {
      width: 100%; border-radius: 8px; border: 1px solid #d3d3d3; padding: 6px 8px; font-size: 13px; box-sizing: border-box;
    }
    .xnc-field textarea { min-height: 50px; resize: vertical; }
    .xnc-hint { font-size: 11px; opacity: 0.7; margin-top: 4px; }
    .xnc-btn {
      border: none; border-radius: 999px; padding: 8px 14px; font-size: 13px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px; background: #4caf50; color: #fff;
    }
    .xnc-btn.secondary { background: #f0f0f0; color: #333; }
    .xnc-output {
      width: 100%; min-height: 120px; padding: 8px; border-radius: 10px; border: 1px solid #ccc; font-size: 12px;
      box-sizing: border-box; resize: vertical; font-family: monospace;
    }
    
    /* Responsive cho m√†n h√¨nh nh·ªè/ƒëi·ªán tho·∫°i: quay v·ªÅ 1 c·ªôt */
    @media (max-width: 768px) {
      .xnc-grid-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="green-theme">
  <div class="xnc-page">
    <header class="xnc-header">
      <h1>Prompt t·∫°o VIDEO ‚Äì X√≥m Ng√†n Chuy·ªán</h1>
      <p>Tool sinh prompt video & 4 keyframe theo ƒë√∫ng ADN X√≥m Ng√†n Chuy·ªán.</p>
    </header>

    <div class="xnc-grid-container">
      <div class="xnc-column-input">
        <section class="xnc-block">
          <h3>1. C·∫•u h√¨nh & ADN</h3>
          <div class="xnc-field">
            <label for="mpProvider">AI Provider</label>
            <select id="mpProvider"><option value="openai">OpenAI</option><option value="gemini">Gemini</option></select>
          </div>
          <div class="xnc-field">
            <label for="mpApiKey">OpenAI API Key</label>
            <input type="password" id="mpApiKey" placeholder="sk-..." />
          </div>
          <div class="xnc-field">
            <label for="xncAdnProfile">ADN / th·∫ø gi·ªõi</label>
            <select id="xncAdnProfile"><option value="xomnganchuyen">X√≥m Ng√†n Chuy·ªán</option></select>
          </div>
        </section>

        <section class="xnc-block">
          <h3>2. Th√¥ng tin c·∫£nh</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="xnc-field">
              <label for="xncVideoId">ID video *</label>
              <input type="text" id="xncVideoId" placeholder="ep08_sc01" />
            </div>
            <div class="xnc-field">
              <label for="xncDuration">ƒê·ªô d√†i (s)</label>
              <input type="text" id="xncDuration" value="2" />
            </div>
          </div>
          <div class="xnc-field">
            <label for="xncAction">H√†nh ƒë·ªông ch√≠nh *</label>
            <input type="text" id="xncAction" placeholder="H√†nh ƒë·ªông..." />
          </div>
          <div class="xnc-field">
            <label for="xncContext">B·ªëi c·∫£nh *</label>
            <input type="text" id="xncContext" placeholder="ƒê·ªãa ƒëi·ªÉm..." />
          </div>
          <div class="xnc-field">
            <label for="xncMotion">M√¥ t·∫£ chuy·ªÉn ƒë·ªông *</label>
            <textarea id="xncMotion" placeholder="Camera, nh√¢n v·∫≠t di chuy·ªÉn th·∫ø n√†o..."></textarea>
          </div>
        </section>

        <section class="xnc-block">
          <h3>3. Nh√¢n v·∫≠t & Mood</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="xnc-field">
              <label for="xncCharacter">Nh√¢n v·∫≠t *</label>
              <select id="xncCharacter"><option value="">-- Ch·ªçn --</option></select>
            </div>
            <div class="xnc-field">
              <label for="xncSignature">Signature</label>
              <select id="xncSignature"><option value="">-- Ch·ªçn --</option></select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="xnc-field">
              <label for="xncCamera">Camera</label>
              <select id="xncCamera">
                <option value="">(T·ª± ƒë·ªông)</option>
                <option value="closeup">Close-up</option>
                <option value="medium">Medium</option>
              </select>
            </div>
            <div class="xnc-field">
              <label for="xncEmotion">Tone m√†u *</label>
              <select id="xncEmotion">
                <option value="comedy" selected>H√†i h∆∞·ªõc</option>
                <option value="happy">Vui v·∫ª</option>
                <option value="drama">Drama</option>
              </select>
            </div>
          </div>
          <div class="xnc-field">
            <label for="xncExtraMood">Mood chi ti·∫øt</label>
            <textarea id="xncExtraMood"></textarea>
          </div>
        </section>
      </div>

      <div class="xnc-column-output">
        <section class="xnc-block">
          <h3>üé¨ Prompt Video & Chu·∫©n h√≥a</h3>
          <div class="xnc-field">
            <textarea id="xncSamplePrompt_vid" placeholder="D√°n prompt m·∫´u v√†o ƒë√¢y ƒë·ªÉ chu·∫©n h√≥a..."></textarea>
          </div>
          <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button class="xnc-btn" id="btnNormalizeVideo">ü™Ñ Chu·∫©n h√≥a</button>
            <button class="xnc-btn" id="btnGenVideo">üé¨ T·∫°o m·ªõi</button>
            <button class="xnc-btn secondary" id="btnCopyVideo">üìã Copy</button>
          </div>
          <textarea id="xncVideoPrompt" class="xnc-output" readonly></textarea>
        </section>

        <section class="xnc-block">
          <h3>üñºÔ∏è 4 Keyframes</h3>
          <div style="margin-bottom: 10px;">
            <button class="xnc-btn" id="btnGenFrames">üñºÔ∏è T·∫°o Frame</button>
            <button class="xnc-btn secondary" id="btnCopyFrames">üìã Copy</button>
          </div>
          <textarea id="xncFramesPrompt" class="xnc-output" readonly></textarea>
        </section>

        <section class="xnc-block">
          <h3>üß© JSON Scene</h3>
          <div style="margin-bottom: 10px;">
            <button class="xnc-btn" id="btnGenJson">üß© T·∫°o JSON</button>
            <button class="xnc-btn secondary" id="btnCopyJson">üìã Copy</button>
          </div>
          <textarea id="xncJsonOutput" class="xnc-output" readonly></textarea>
        </section>
      </div>
    </div>
  </div>

  <!-- JS ADN -->
  <script src="/public/js/xomnganchuyen.js"></script>
  <script>
    /* ========= Helper API / Provider (gi·ªëng trang image) ========= */

    function getActiveProvider() {
      const select = document.getElementById("mpProvider");
      if (select && select.value) {
        return select.value;
      }
      return localStorage.getItem("nini_active_provider") || "openai";
    }

    function setActiveProvider(provider) {
      localStorage.setItem("nini_active_provider", provider);
    }

    function initProviderSelectLocal() {
      const select = document.getElementById("mpProvider");
      if (!select) return;
      const saved = localStorage.getItem("nini_active_provider") || "openai";
      select.value = saved;
      select.addEventListener("change", () => {
        const v = select.value || "openai";
        setActiveProvider(v);
        updateProviderHint();
      });
      updateProviderHint();
    }

    function updateProviderHint() {
      const p = getActiveProvider();
      const el = document.getElementById("mpProviderHint");
      if (!el) return;
      if (p !== "openai") {
        el.textContent =
          "Hi·ªán t·∫°i chu·∫©n ho√° prompt ch·ªâ h·ªó tr·ª£ OpenAI. Vui l√≤ng ch·ªçn OpenAI n·∫øu mu·ªën d√πng n√∫t chu·∫©n ho√°.";
      } else {
        el.textContent =
          "OpenAI ƒëang ƒë∆∞·ª£c d√πng ƒë·ªÉ chu·∫©n ho√° prompt (gpt-4.1-mini).";
      }
    }

    function getOpenAIKeyForXNC() {
      const input = document.getElementById("mpApiKey");
      if (input && input.value.trim()) return input.value.trim();

      try {
        const raw =
          localStorage.getItem("apiProfiles") ||
          localStorage.getItem("api_profiles") ||
          "";
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            const found = parsed.find(
              p =>
                p &&
                (p.provider === "openai" || p.provider === "OpenAI") &&
                p.apiKey
            );
            if (found) return found.apiKey;
          } else if (typeof parsed === "object") {
            for (const k in parsed) {
              const p = parsed[k];
              if (
                p &&
                (p.provider === "openai" || p.provider === "OpenAI") &&
                p.apiKey
              ) {
                return p.apiKey;
              }
            }
          }
        }
      } catch (e) {
        console.warn("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c apiProfiles t·ª´ localStorage:", e);
      }
      return "";
    }

    async function callXNCAnalyzer(rawSamplePrompt, target) {
      const provider = getActiveProvider();
      const apiKey = getOpenAIKeyForXNC();

      if (!rawSamplePrompt || !rawSamplePrompt.trim()) {
        alert("D√°n prompt m·∫´u v√†o tr∆∞·ªõc ƒë√£ nha.");
        return "";
      }

      if (provider !== "openai") {
        alert(
          "Module chu·∫©n ho√° prompt hi·ªán ch·ªâ h·ªó tr·ª£ OpenAI.\n" +
            "B·∫°n ƒëang ch·ªçn: " +
            provider +
            ". Vui l√≤ng ch·ªçn OpenAI trong ph·∫ßn c·∫•u h√¨nh AI."
        );
        return "";
      }

      if (!apiKey) {
        alert(
          "Ch∆∞a c√≥ OpenAI API key.\n" +
            "- Nh·∫≠p key v√†o √¥ OpenAI API Key, HO·∫∂C\n" +
            "- ƒê·∫£m b·∫£o b·∫°n ƒë√£ l∆∞u profile OpenAI trong Admin (localStorage.apiProfiles)."
        );
        return "";
      }

      const mode =
        target === "video"
          ? "short animation video (1‚Äì3 seconds)"
          : "single illustration image";

      const userContent = `
You are a prompt formatter for the Vietnamese chibi universe "X√≥m Ng√†n Chuy·ªán".

Your job:
- Take the raw prompt below (may come from any AI tool).
- Rewrite it into ONE clean English prompt that strictly follows the ADN of "X√≥m Ng√†n Chuy·ªán".

ADN:
- 2D pastel chibi style
- Green & brown Vietnamese village / primary school vibe
- Setting: Vietnamese primary school or small neighbourhood
- Warm, funny, lighthearted, not dark, not violent.

Output:
- One single English prompt for a ${mode}.
- No explanation, no numbering.

Raw prompt:
"""${rawSamplePrompt.trim()}"""
      `.trim();

      try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              {
                role: "system",
                content:
                  "You convert any raw prompt into the ADN style of the Vietnamese chibi universe X√≥m Ng√†n Chuy·ªán."
              },
              { role: "user", content: userContent }
            ],
            temperature: 0.8,
            max_tokens: 400
          })
        });

        if (!res.ok) {
          console.error("OpenAI XNC analyzer error:", await res.text());
          alert("L·ªói khi g·ªçi OpenAI ƒë·ªÉ chu·∫©n ho√° prompt.");
          return "";
        }

        const data = await res.json();
        const text =
          data.choices?.[0]?.message?.content?.trim() || "";

        return text;
      } catch (err) {
        console.error("L·ªói callXNCAnalyzer:", err);
        alert("C√≥ l·ªói k·∫øt n·ªëi khi chu·∫©n ho√° prompt.");
        return "";
      }
    }

    /* ========= Logic XNC cho VIDEO ========= */
    document.addEventListener("DOMContentLoaded", function () {
      initProviderSelectLocal();

      const adnSelect = document.getElementById("xncAdnProfile");

      const videoIdInput = document.getElementById("xncVideoId");
      const actionInput = document.getElementById("xncAction");
      const contextInput = document.getElementById("xncContext");
      const motionInput = document.getElementById("xncMotion");
      const durationInput = document.getElementById("xncDuration");

      const charSelect = document.getElementById("xncCharacter");
      const sigSelect = document.getElementById("xncSignature");
      const cameraSelect = document.getElementById("xncCamera");
      const emotionSelect = document.getElementById("xncEmotion");
      const extraMoodInput = document.getElementById("xncExtraMood");

      const videoPromptOutput = document.getElementById("xncVideoPrompt");
      const framesPromptOutput = document.getElementById("xncFramesPrompt");
      const jsonOutput = document.getElementById("xncJsonOutput");

      const btnGenVideo = document.getElementById("btnGenVideo");
      const btnCopyVideo = document.getElementById("btnCopyVideo");
      const btnGenFrames = document.getElementById("btnGenFrames");
      const btnCopyFrames = document.getElementById("btnCopyFrames");
      const btnGenJson = document.getElementById("btnGenJson");
      const btnCopyJson = document.getElementById("btnCopyJson");
      const btnNormalizeVideo = document.getElementById("btnNormalizeVideo");

      if (!window.XNC) {
        console.error("XNC core not found");
        return;
      }

      function loadProfileAndFill() {
        const profileId = adnSelect.value || "xomnganchuyen";

        charSelect.innerHTML =
          '<option value="">-- Ch·ªçn nh√¢n v·∫≠t --</option>';
        sigSelect.innerHTML =
          '<option value="">-- Ch·ªçn (kh√¥ng b·∫Øt bu·ªôc) --</option>';

        XNC.setProfile(profileId)
          .then(() => {
            const chars = XNC.getCharacterList();
            chars.forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c.id;
              opt.textContent = `${c.name} ‚Äì ${c.role}`;
              charSelect.appendChild(opt);
            });
          })
          .catch((e) => console.error(e));
      }

      XNC.ready(() => {
        loadProfileAndFill();
      });

      adnSelect.addEventListener("change", () => {
        loadProfileAndFill();
      });

      charSelect.addEventListener("change", () => {
        const id = charSelect.value;
        sigSelect.innerHTML =
          '<option value="">-- Ch·ªçn (kh√¥ng b·∫Øt bu·ªôc) --</option>';
        if (!id) return;

        const sigs = XNC.getSignaturesFor(id);
        sigs.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.label;
          sigSelect.appendChild(opt);
        });
      });

      function buildBaseScenePrompt() {
        const characterId = charSelect.value;
        const signatureId = sigSelect.value || "";
        const actionText = actionInput.value.trim();
        const contextText = contextInput.value.trim();
        const cameraKey = cameraSelect.value || "";
        const emotionKey = emotionSelect.value || "comedy";
        const extraMood = extraMoodInput.value.trim();

        if (!characterId || !actionText || !contextText) {
          alert("Vui l√≤ng nh·∫≠p H√†nh ƒë·ªông, B·ªëi c·∫£nh v√† ch·ªçn Nh√¢n v·∫≠t tr∆∞·ªõc.");
          return null;
        }

        const basePrompt = XNC.buildCharacterPrompt({
          characterId,
          signatureId,
          actionText,
          emotionKey,
          contextText,
          cameraKey,
          lightingKey: "school_daylight",
          extraMood
        });

        return basePrompt;
      }

      function buildVideoPrompt() {
        const basePrompt = buildBaseScenePrompt();
        if (!basePrompt) return null;

        const motion = motionInput.value.trim();
        const duration = (durationInput.value || "2").trim();

        const text = `
Short animated video in the ${XNC.getCurrentProfileId()} Vietnamese chibi 2D style,
pastel colors, green and brown brand palette.

Scene description:
${basePrompt}

Motion:
${motion || "subtle character motion matching the described action, no camera shake."}

Technical notes:
- Duration: about ${duration} seconds
- Stable camera, no heavy distortion
- Keep character design consistent across frames
        `.trim();

        return text;
      }

      function buildKeyframesPrompt() {
        const basePrompt = buildBaseScenePrompt();
        if (!basePrompt) return null;

        const frames = [
          {
            index: 1,
            label: "establish",
            prompt: `Frame 1 ‚Äì Establish shot: ${basePrompt}, character and environment clearly visible.`
          },
          {
            index: 2,
            label: "action_peak",
            prompt: `Frame 2 ‚Äì Action peak: ${basePrompt}, the main action reaches its most intense moment.`
          },
          {
            index: 3,
            label: "reaction",
            prompt: `Frame 3 ‚Äì Reaction shot: close-up on the character reacting emotionally to what just happened.`
          },
          {
            index: 4,
            label: "ending",
            prompt: `Frame 4 ‚Äì Ending / comedic freeze: final pose that clearly concludes the gag, can be slightly exaggerated.`
          }
        ];

        const textLines = frames.map((f) => `${f.index}) ${f.prompt}`);
        return {
          text: textLines.join("\n\n"),
          frames
        };
      }

      btnGenVideo.addEventListener("click", () => {
        const vPrompt = buildVideoPrompt();
        if (vPrompt) {
          videoPromptOutput.value = vPrompt;
        }
      });

      btnCopyVideo.addEventListener("click", () => {
        const text = videoPromptOutput.value.trim();
        if (!text) {
          alert("Ch∆∞a c√≥ prompt video ƒë·ªÉ copy.");
          return;
        }
        navigator.clipboard.writeText(text);
        alert("ƒê√£ copy prompt video.");
      });

      let lastFrameData = null;

      btnGenFrames.addEventListener("click", () => {
        const result = buildKeyframesPrompt();
        if (!result) return;
        framesPromptOutput.value = result.text;
        lastFrameData = result.frames;
      });

      btnCopyFrames.addEventListener("click", () => {
        const text = framesPromptOutput.value.trim();
        if (!text) {
          alert("Ch∆∞a c√≥ prompt 4 frame ƒë·ªÉ copy.");
          return;
        }
        navigator.clipboard.writeText(text);
        alert("ƒê√£ copy 4 frame.");
      });

      btnNormalizeVideo.addEventListener("click", async () => {
        const sample = document.getElementById("xncSamplePrompt_vid").value;
        const result = await callXNCAnalyzer(sample, "video");
        if (result) {
          videoPromptOutput.value = result;
        }
      });

      btnGenJson.addEventListener("click", () => {
        const id = videoIdInput.value.trim();
        if (!id) {
          alert("Vui l√≤ng nh·∫≠p ID video / ID c·∫£nh.");
          return;
        }

        const videoPrompt = videoPromptOutput.value.trim();
        if (!videoPrompt) {
          alert("B·∫°n ch∆∞a t·∫°o prompt video. B·∫•m 'T·∫°o Prompt Video' ho·∫∑c 'Chu·∫©n ho√°' tr∆∞·ªõc.");
          return;
        }

        if (!lastFrameData) {
          const result = buildKeyframesPrompt();
          if (!result) return;
          lastFrameData = result.frames;
        }

        const characterId = charSelect.value;
        const signatureId = sigSelect.value || "";
        const actionText = actionInput.value.trim();
        const contextText = contextInput.value.trim();
        const cameraKey = cameraSelect.value || "";
        const emotionKey = emotionSelect.value || "comedy";
        const extraMood = extraMoodInput.value.trim();
        const motion = motionInput.value.trim();
        const duration = (durationInput.value || "2").trim();

        if (!characterId || !actionText || !contextText) {
          alert("Thi·∫øu H√†nh ƒë·ªông, B·ªëi c·∫£nh ho·∫∑c Nh√¢n v·∫≠t.");
          return;
        }

        const obj = {
          id: id,
          type: "video",
          series: XNC.getCurrentProfileId(),
          characterId: characterId,
          signatureId: signatureId || null,
          action: actionText,
          context: contextText,
          camera: cameraKey || null,
          emotion: emotionKey,
          mood: extraMood || null,
          motion: motion || null,
          durationSeconds: Number(duration) || 2,
          videoPrompt: videoPrompt,
          keyframes: lastFrameData,
          createdAt: new Date().toISOString()
        };

        jsonOutput.value = JSON.stringify(obj, null, 2);
      });

      btnCopyJson.addEventListener("click", () => {
        const text = jsonOutput.value.trim();
        if (!text) {
          alert("Ch∆∞a c√≥ JSON ƒë·ªÉ copy. B·∫•m 'T·∫°o JSON' tr∆∞·ªõc.");
          return;
        }
        navigator.clipboard.writeText(text);
        alert("ƒê√£ copy JSON scene video.");
      });
    });
  </script>
</body>
</html>


