<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XNC Story Generator (Auto-Write)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="green-theme.css">
    
    <style>
        /* THEME DNA XANH - NÂU */
        body {
            background: linear-gradient(135deg, #CDECC1 0%, #F4E8A2 100%);
            font-family: 'Segoe UI', sans-serif;
            color: #5D4037;
            padding: 20px;
        }

        .studio-card {
            background: rgba(255, 255, 255, 0.98);
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(139, 94, 60, 0.15);
            border: 4px solid #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 90vh;
        }

        .studio-header {
            background: #8CCB7A; padding: 20px 30px; color: white;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 5px solid #B9885D;
        }

        /* KHU VỰC API KEY */
        .api-box {
            background: #FFF3E0; padding: 10px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #FFE0B2; font-size: 13px;
        }
        .api-input {
            border: 1px solid #FFB74D; padding: 5px 10px; border-radius: 5px; width: 250px; background: white;
        }

        .studio-body {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            flex-grow: 1;
        }

        /* LEFT COLUMN */
        .label-dna { color: #8CCB7A; font-weight: 800; margin-bottom: 8px; display: block; text-transform: uppercase; font-size: 13px; }
        .input-dna {
            width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 12px; background: #FAFAFA; margin-bottom: 15px; box-sizing: border-box; transition: 0.3s;
        }
        .input-dna:focus { border-color: #8CCB7A; outline: none; background: white; }

        .mode-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .mode-card {
            border: 2px solid #E0E0E0; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; background: white; font-size: 13px;
        }
        .mode-card.active { border-color: #B9885D; background: #FFF8E1; color: #E65100; font-weight: bold; }

        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; padding: 10px; background: #F1F8E9; border-radius: 12px; border: 1px dashed #8CCB7A; }
        .char-item { font-size: 13px; background: white; padding: 6px; border-radius: 6px; border: 1px solid #ddd; display: flex; gap: 5px; align-items: center; }

        .btn-generate {
            background: linear-gradient(135deg, #B9885D, #8D6E63); color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(185, 136, 93, 0.4); }
        .btn-generate:disabled { background: #ccc; cursor: wait; }

        /* RIGHT COLUMN (RESULT) */
        .result-container {
            background: #FFFDE7; border: 2px dashed #FBC02D; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; position: relative;
        }
        .story-content {
            flex-grow: 1; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; line-height: 1.6; font-size: 15px; color: #3E2723; overflow-y: auto; max-height: 600px; padding-right: 10px;
        }
        
        /* Hiệu ứng Loading */
        .loading-spinner {
            display: none; text-align: center; margin-top: 50px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8CCB7A; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="studio-card">
    <div class="studio-header">
        <div>
            <h2 style="margin:0">✨ XNC Story Auto-Writer</h2>
            <p style="margin:0; font-size:13px; opacity:0.9">Viết kịch bản tự động bằng AI (Gemini)</p>
        </div>
    </div>

    <div class="api-box">
        <span>🔑 Google Gemini API Key:</span>
        <input type="password" id="apiKeyInput" class="api-input" placeholder="Dán API Key vào đây..." onchange="saveKey()">
        <span style="color:#666; font-style:italic;">(Lưu tự động trên máy bạn)</span>
        <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#B9885D; margin-left:auto; font-weight:bold; text-decoration:none;">👉 Lấy Key miễn phí tại đây</a>
    </div>

    <div class="studio-body">
        <div>
            <label class="label-dna">1. Thể Loại (Mode)</label>
            <div class="mode-grid">
                <div class="mode-card active" onclick="setMode(this, 'funny')">🤣 Hài Hước</div>
                <div class="mode-card" onclick="setMode(this, 'spooky')">👻 Ma Mị</div>
                <div class="mode-card" onclick="setMode(this, 'emotional')">🥺 Cảm Động</div>
            </div>

            <label class="label-dna">2. Ý Tưởng Cốt Truyện</label>
            <textarea id="storyIdea" class="input-dna" rows="3" placeholder="Vd: TùmLa lén lấy trộm xoài của Cô Hai Ngàn nhưng bị con ngỗng rượt chạy té khói..."></textarea>

            <label class="label-dna">3. Diễn Viên (Chọn từ Data)</label>
            <div id="charList" class="char-grid">Loading...</div>

            <button id="btnGen" class="btn-generate" onclick="generateStory()">✨ VIẾT KỊCH BẢN NGAY</button>
        </div>

        <div class="result-container">
            <div id="loading" class="loading-spinner">
                <div class="spinner"></div>
                <div style="color:#8CCB7A; font-weight:bold;">AI đang viết truyện, đợi xíu nhen...</div>
                <div style="font-size:12px; color:#666;">(Đang nhập vai Bô-Lô, Tùm-La...)</div>
            </div>
            
            <div id="finalStory" class="story-content">
                <div style="text-align:center; color:#999; margin-top:100px;">
                    📝 Kết quả kịch bản sẽ hiện ra ở đây.<br>Không cần copy đi đâu cả!
                </div>
            </div>

            <button onclick="copyStory()" style="position:absolute; top:10px; right:10px; background:white; border:1px solid #ccc; padding:5px 10px; border-radius:5px; cursor:pointer;">📋 Copy</button>
        </div>
    </div>
</div>

<script>
    // URL File JSON Data
    const DATA_PATH = "adn/xomnganchuyen/"; 
    const CHAR_URL = DATA_PATH + "XNC_characters.json";
    
    let charData = [];
    let currentMode = 'funny';

    // 1. KHỞI TẠO
    window.onload = async () => {
        // Load API Key cũ nếu có
        const savedKey = localStorage.getItem('xnc_gemini_key');
        if(savedKey) document.getElementById('apiKeyInput').value = savedKey;

        // Load Nhân vật
        try {
            const res = await fetch(CHAR_URL);
            charData = (await res.json()).characters || [];
            renderChars();
        } catch (e) {
            document.getElementById('charList').innerText = "⚠️ Không tải được nhân vật.";
        }
    }

    function saveKey() {
        const key = document.getElementById('apiKeyInput').value;
        localStorage.setItem('xnc_gemini_key', key);
    }

    function renderChars() {
        const container = document.getElementById('charList');
        container.innerHTML = '';
        charData.forEach(c => {
            container.innerHTML += `
                <label class="char-item">
                    <input type="checkbox" value="${c.name}" data-desc="${c.personality || c.base_desc_en}">
                    ${c.name}
                </label>`;
        });
    }

    function setMode(el, mode) {
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        currentMode = mode;
    }

    // 2. GỌI API GEMINI (AUTO WRITER)
    async function generateStory() {
        const apiKey = document.getElementById('apiKeyInput').value;
        const storyIdea = document.getElementById('storyIdea').value;
        
        if(!apiKey) { alert("⚠️ Bạn chưa nhập API Key! Nhấn vào link 'Lấy Key miễn phí' ở trên nhé."); return; }
        if(!storyIdea) { alert("⚠️ Nhập ý tưởng cốt truyện đi bạn ơi!"); return; }

        // Lấy nhân vật đã chọn
        let selectedChars = [];
        document.querySelectorAll('#charList input:checked').forEach(cb => {
            selectedChars.push(`- ${cb.value}: ${cb.dataset.desc}`);
        });

        if(selectedChars.length === 0) { alert("⚠️ Chọn ít nhất 1 nhân vật!"); return; }

        // Hiển thị Loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('finalStory').style.display = 'none';
        document.getElementById('btnGen').disabled = true;

        // TẠO PROMPT GỬI CHO AI
        const prompt = `
        Bạn là Biên kịch chuyên nghiệp cho series hoạt hình/podcast "Xóm Ngàn Chuyện".
        Hãy viết một kịch bản hội thoại chi tiết (Dialogue Script) dựa trên thông tin sau:

        1. CỐT TRUYỆN: ${storyIdea}
        2. THỂ LOẠI: ${currentMode} (Vui nhộn/Ma mị/Cảm động)
        3. NHÂN VẬT & TÍNH CÁCH (DNA):
        ${selectedChars.join('\n')}

        YÊU CẦU:
        - Ngôn ngữ: Tiếng Việt (Giọng văn Miền Tây Nam Bộ, tự nhiên, đời thường).
        - Định dạng: [Tên Nhân Vật]: Lời thoại...
        - Kèm chỉ dẫn âm thanh [SFX] và cảm xúc (trong ngoặc).
        - Giữ đúng tính cách nhân vật (Vd: TùmLa điệu đà, BôLô hay soi mói...).
        - Có phần Mở đầu, Thân bài (Cao trào), Kết thúc.

        HÃY VIẾT NGAY BÂY GIỜ:
        `;

        try {
            // GỌI TRỰC TIẾP ĐẾN GOOGLE GEMINI API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if(data.error) { throw new Error(data.error.message); }

            const aiText = data.candidates[0].content.parts[0].text;
            
            // Hiển thị kết quả
            document.getElementById('finalStory').innerText = aiText;

        } catch (error) {
            alert("Lỗi AI: " + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('finalStory').style.display = 'block';
            document.getElementById('btnGen').disabled = false;
        }
    }

    function copyStory() {
        navigator.clipboard.writeText(document.getElementById('finalStory').innerText);
        alert("Đã copy kịch bản!");
    }
</script>

</body>
</html>