<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Prompt t·∫°o ·∫¢NH ‚Äì X√≥m Ng√†n Chuy·ªán</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS chung c·ªßa site -->
  <link rel="stylesheet" href="/public/style.css" />
  <!-- Theme xanh l√° & n√¢u -->
  <link rel="stylesheet" href="/public/green-theme.css" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .xnc-page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    .xnc-header {
      margin-bottom: 20px;
    }
    .xnc-header h1 {
      margin: 0 0 4px;
      font-size: 24px;
    }
    .xnc-header p {
      margin: 0;
      opacity: 0.8;
    }
    .xnc-block {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }
    .xnc-block h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .xnc-field {
      margin-bottom: 10px;
    }
    .xnc-field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .xnc-field input[type="text"],
    .xnc-field input[type="password"],
    .xnc-field textarea,
    .xnc-field select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d3d3d3;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
    }
    .xnc-field textarea {
      min-height: 56px;
      resize: vertical;
    }
    .xnc-hint {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }
    .xnc-actions {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .xnc-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #4caf50;
      color: #fff;
    }
    .xnc-btn.secondary {
      background: #f0f0f0;
      color: #333;
    }
    .xnc-output {
      width: 100%;
      min-height: 160px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 13px;
      box-sizing: border-box;
      resize: vertical;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }
    .xnc-tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      margin-top: 4px;
    }
    .xnc-tag {
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.06);
    }
  </style>
</head>
<body class="green-theme">
  <div class="xnc-page">
    <header class="xnc-header">
      <h1>Prompt t·∫°o ·∫¢NH ‚Äì X√≥m Ng√†n Chuy·ªán</h1>
      <p>Tool sinh prompt h√¨nh chu·∫©n ADN (style) + xu·∫•t JSON cho t·ª´ng c·∫£nh 2D.</p>
    </header>

    <!-- C·∫§U H√åNH API / PROVIDER -->
    <section class="xnc-block">
      <h3>C·∫•u h√¨nh AI d√πng ƒë·ªÉ chu·∫©n ho√° prompt</h3>
      <div class="xnc-field">
        <label for="mpProvider">AI Provider</label>
        <select id="mpProvider">
          <option value="openai">OpenAI</option>
          <option value="gemini">Google AI (Gemini)</option>
          <option value="grok">Grok (xAI)</option>
        </select>
        <div class="xnc-hint" id="mpProviderHint">
          Hi·ªán t·∫°i ch·ª©c nƒÉng chu·∫©n ho√° prompt ch·ªâ h·ªó tr·ª£ OpenAI.
        </div>
      </div>
      <div class="xnc-field">
        <label for="mpApiKey">OpenAI API Key</label>
        <input
          type="password"
          id="mpApiKey"
          placeholder="sk-..."
        />
        <div class="xnc-hint">
          N·∫øu ƒë·ªÉ tr·ªëng, h·ªá th·ªëng s·∫Ω c·ªë g·∫Øng ƒë·ªçc key t·ª´ c·∫•u h√¨nh ƒë√£ l∆∞u trong <code>localStorage.apiProfiles</code>.
        </div>
      </div>
    </section>

    <!-- CH·ªåN ADN / SERIES -->
    <section class="xnc-block">
      <h3>Ch·ªçn ADN / Series</h3>
      <div class="xnc-field">
        <label for="xncAdnProfile">ADN / th·∫ø gi·ªõi *</label>
        <select id="xncAdnProfile">
          <option value="xomnganchuyen">X√≥m Ng√†n Chuy·ªán (m·∫∑c ƒë·ªãnh)</option>
          <!-- Sau n√†y th√™m series kh√°c:
          <option value="series2">Series 2</option>
          -->
        </select>
        <div class="xnc-hint">
          M·ªói ADN t∆∞∆°ng ·ª©ng v·ªõi th∆∞ m·ª•c <code>/adn/&lt;profileId&gt;</code> ch·ª©a JSON nh√¢n v·∫≠t, style, audio.
        </div>
      </div>
    </section>

    <!-- VIBE C·ªê ƒê·ªäNH -->
    <section class="xnc-block">
      <h3>Vibe &amp; phong c√°ch X√≥m Ng√†n Chuy·ªán</h3>
      <div class="xnc-tag-row">
        <span class="xnc-tag">Green &amp; Brown Vietnamese vibe</span>
        <span class="xnc-tag">Pastel chibi 2D</span>
        <span class="xnc-tag">Vietnamese primary school / x√≥m nh·ªè</span>
      </div>
      <p class="xnc-hint">
        ADN n√†y ƒë∆∞·ª£c ƒëi·ªÅu khi·ªÉn b·ªüi <code>xomnganchuyen.js</code> + JSON trong th∆∞ m·ª•c <code>/adn</code>.
      </p>
    </section>

    <!-- H√ÄNH ƒê·ªòNG & B·ªêI C·∫¢NH -->
    <section class="xnc-block">
      <h3>H√†nh ƒë·ªông &amp; b·ªëi c·∫£nh (b·∫Øt bu·ªôc)</h3>

      <div class="xnc-field">
        <label for="xncImageId">ID image / ID c·∫£nh *</label>
        <input
          type="text"
          id="xncImageId"
          placeholder="V√≠ d·ª•: ep08_sc01_imgA"
        />
        <div class="xnc-hint">
          ƒê·∫∑t theo t·∫≠p ‚Äì c·∫£nh ‚Äì frame cho d·ªÖ qu·∫£n l√Ω storyboard. V√≠ d·ª•: <code>ep08_sc01_imgA</code>.
        </div>
      </div>

      <div class="xnc-field">
        <label for="xncAction">H√†nh ƒë·ªông ch√≠nh c·ªßa c·∫£nh *</label>
        <input
          type="text"
          id="xncAction"
          placeholder="V√≠ d·ª•: B√¥-l√¥ soi cu·ªën s·ªï ƒëen, T√πm-la lao t·ªõi x·ª≠ l√Ω..."
        />
      </div>

      <div class="xnc-field">
        <label for="xncContext">B·ªëi c·∫£nh / kh√¥ng gian *</label>
        <input
          type="text"
          id="xncContext"
          placeholder="V√≠ d·ª•: trong l·ªõp 2A, h√†nh lang tr∆∞·ªùng, s√¢n tr∆∞·ªùng gi·ªù ra ch∆°i..."
        />
      </div>
    </section>

    <!-- NH√ÇN V·∫¨T & BI·ªÇU C·∫¢M -->
    <section class="xnc-block">
      <h3>Nh√¢n v·∫≠t &amp; bi·ªÉu c·∫£m ƒë·∫∑c tr∆∞ng</h3>

      <div class="xnc-field">
        <label for="xncCharacter">Nh√¢n v·∫≠t *</label>
        <select id="xncCharacter">
          <option value="">-- Ch·ªçn nh√¢n v·∫≠t --</option>
          <!-- ƒê·ªï b·∫±ng JS t·ª´ XNC -->
        </select>
      </div>

      <div class="xnc-field">
        <label for="xncSignature">Bi·ªÉu c·∫£m / h√†nh vi ƒë·∫∑c tr∆∞ng</label>
        <select id="xncSignature">
          <option value="">-- Ch·ªçn (kh√¥ng b·∫Øt bu·ªôc) --</option>
          <!-- ƒê·ªï b·∫±ng JS -->
        </select>
        <div class="xnc-hint">
          N·∫øu kh√¥ng ch·ªçn, c·∫£nh v·∫´n d√πng h√†nh ƒë·ªông ch√≠nh; signature l√† ‚Äúth√≥i quen ri√™ng‚Äù c·ªßa t·ª´ng nh√¢n v·∫≠t.
        </div>
      </div>
    </section>

    <!-- CAMERA & TONE -->
    <section class="xnc-block">
      <h3>G√≥c nh√¨n, tone c·∫£m x√∫c &amp; mood</h3>

      <div class="xnc-field">
        <label for="xncCamera">G√≥c nh√¨n / camera</label>
        <select id="xncCamera">
          <option value="">(Kh√¥ng b·∫Øt bu·ªôc)</option>
          <option value="closeup">Close-up (c·∫≠n m·∫∑t)</option>
          <option value="medium">Medium shot (n·ª≠a ng∆∞·ªùi / to√†n th√¢n)</option>
          <option value="dramatic_low">Low angle drama</option>
          <option value="comedy_zoom">Comedy punch-in</option>
        </select>
      </div>

      <div class="xnc-field">
        <label for="xncEmotion">Tone c·∫£m x√∫c / m√†u ch√≠nh *</label>
        <select id="xncEmotion">
          <option value="happy">Vui / ·∫•m</option>
          <option value="comedy" selected>H√†i h∆∞·ªõc</option>
          <option value="warm">·∫§m √°p</option>
          <option value="drama">Drama / nghi√™m t√∫c</option>
          <option value="twist">Twist / b·∫•t ng·ªù</option>
          <option value="embarrassed">Ng·∫°i / x·∫•u h·ªï</option>
        </select>
      </div>

      <div class="xnc-field">
        <label for="xncExtraMood">Mood chi ti·∫øt (t√πy ch·ªçn)</label>
        <textarea
          id="xncExtraMood"
          placeholder="V√≠ d·ª•: h∆°i cƒÉng th·∫≥ng nh∆∞ng v·∫´n pastel, c·∫£m gi√°c h·ªçc ƒë∆∞·ªùng Vi·ªát Nam, Noel vui nh·ªôn..."
        ></textarea>
      </div>
    </section>

    <!-- PROMPT M·∫™U + CHU·∫®N HO√Å -->
    <section class="xnc-block">
      <h3>Prompt m·∫´u t·ª´ AI kh√°c (tu·ª≥ ch·ªçn)</h3>

      <div class="xnc-field">
        <label for="xncSamplePrompt">D√°n prompt g·ªëc (Flow / Meta / Sora / v.v.)</label>
        <textarea
          id="xncSamplePrompt"
          placeholder="D√°n prompt c·ªßa AI kh√°c v√†o ƒë√¢y..."
        ></textarea>
        <p class="xnc-hint">
          B·∫•m n√∫t b√™n d∆∞·ªõi ƒë·ªÉ chu·∫©n ho√° prompt n√†y theo ADN X√≥m Ng√†n Chuy·ªán:
          chibi 2D pastel, xanh l√° &amp; n√¢u, ti·ªÉu h·ªçc Vi·ªát Nam, ƒë√∫ng t√≠nh c√°ch nh√¢n v·∫≠t.
        </p>
      </div>

      <div class="xnc-field">
        <button type="button" class="xnc-btn" id="btnNormalizeImage">
          Chu·∫©n ho√° prompt ·∫¢NH theo ADN X√≥m Ng√†n Chuy·ªán (OpenAI)
        </button>
      </div>
    </section>

    <!-- PROMPT ·∫¢NH -->
    <section class="xnc-block">
      <h3>üñºÔ∏è Prompt t·∫°o ra (·∫¢NH ‚Äì ti·∫øng Anh, chu·∫©n ADN XNC)</h3>

      <div class="xnc-actions">
        <button type="button" class="xnc-btn" id="btnGenPrompt">
          üñºÔ∏è T·∫°o Prompt ·∫£nh (t·ª´ form)
        </button>
        <button type="button" class="xnc-btn secondary" id="btnCopyPrompt">
          üìã Copy Prompt ·∫£nh
        </button>
      </div>

      <div class="xnc-field" style="margin-top: 10px;">
        <textarea
          id="xncOutput"
          class="xnc-output"
          placeholder="Prompt s·∫Ω hi·ªán ·ªü ƒë√¢y sau khi b·∫°n b·∫•m 'T·∫°o Prompt ·∫£nh' ho·∫∑c sau khi chu·∫©n ho√° t·ª´ prompt m·∫´u..."
        ></textarea>
      </div>

      <p class="xnc-hint">
        Prompt ƒë√£ bao g·ªìm: phong c√°ch chibi 2D, pastel, vibe tr∆∞·ªùng h·ªçc Vi·ªát Nam, brand xanh l√° &amp; n√¢u c·ªßa X√≥m Ng√†n Chuy·ªán.
      </p>
    </section>

    <!-- JSON EXPORT -->
    <section class="xnc-block">
      <h3>üß© JSON l∆∞u c·∫£nh ·∫¢NH (shot)</h3>

      <div class="xnc-actions">
        <button type="button" class="xnc-btn" id="btnGenJson">
          üß© T·∫°o JSON
        </button>
        <button type="button" class="xnc-btn secondary" id="btnCopyJson">
          üìã Copy JSON
        </button>
      </div>

      <div class="xnc-field" style="margin-top: 10px;">
        <textarea
          id="xncJsonOutput"
          class="xnc-output"
          placeholder="JSON s·∫Ω hi·ªán ·ªü ƒë√¢y sau khi b·∫°n b·∫•m 'T·∫°o JSON'..."
        ></textarea>
      </div>

      <p class="xnc-hint">
        JSON n√†y ch·ª©a ƒë·∫ßy ƒë·ªß: ID image, action, context, nh√¢n v·∫≠t, camera, tone, prompt ·∫£nh‚Ä¶
        B·∫°n c√≥ th·ªÉ l∆∞u th√†nh file <code>.json</code> ho·∫∑c gom nhi·ªÅu shot th√†nh storyboard.
      </p>
    </section>
  </div>

  <!-- JS ADN ƒëa profile -->
  <script src="/public/js/xomnganchuyen.js"></script>
  <script>
    /* ========= Helper API / Provider ========= */

    function getActiveProvider() {
      const select = document.getElementById("mpProvider");
      if (select && select.value) {
        return select.value;
      }
      return localStorage.getItem("nini_active_provider") || "openai";
    }

    function setActiveProvider(provider) {
      localStorage.setItem("nini_active_provider", provider);
    }

    function initProviderSelectLocal() {
      const select = document.getElementById("mpProvider");
      if (!select) return;
      const saved = localStorage.getItem("nini_active_provider") || "openai";
      select.value = saved;
      select.addEventListener("change", () => {
        const v = select.value || "openai";
        setActiveProvider(v);
        updateProviderHint();
      });
      updateProviderHint();
    }

    function updateProviderHint() {
      const p = getActiveProvider();
      const el = document.getElementById("mpProviderHint");
      if (!el) return;
      if (p !== "openai") {
        el.textContent =
          "Hi·ªán t·∫°i chu·∫©n ho√° prompt ch·ªâ h·ªó tr·ª£ OpenAI. Vui l√≤ng ch·ªçn OpenAI n·∫øu mu·ªën d√πng n√∫t chu·∫©n ho√°.";
      } else {
        el.textContent =
          "OpenAI ƒëang ƒë∆∞·ª£c d√πng ƒë·ªÉ chu·∫©n ho√° prompt (g·ªçi model gpt-4.1-mini).";
      }
    }

    // L·∫•y OpenAI key t·ª´ √¥ input ho·∫∑c t·ª´ localStorage.apiProfiles (format gi·ªëng admin)
    function getOpenAIKeyForXNC() {
      const input = document.getElementById("mpApiKey");
      if (input && input.value.trim()) return input.value.trim();

      try {
        const raw =
          localStorage.getItem("apiProfiles") ||
          localStorage.getItem("api_profiles") ||
          "";
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            const found = parsed.find(
              p =>
                p &&
                (p.provider === "openai" || p.provider === "OpenAI") &&
                p.apiKey
            );
            if (found) return found.apiKey;
          } else if (typeof parsed === "object") {
            for (const k in parsed) {
              const p = parsed[k];
              if (
                p &&
                (p.provider === "openai" || p.provider === "OpenAI") &&
                p.apiKey
              ) {
                return p.apiKey;
              }
            }
          }
        }
      } catch (e) {
        console.warn("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c apiProfiles t·ª´ localStorage:", e);
      }
      return "";
    }

    async function callXNCAnalyzer(rawSamplePrompt, target) {
      const provider = getActiveProvider();
      const apiKey = getOpenAIKeyForXNC();

      if (!rawSamplePrompt || !rawSamplePrompt.trim()) {
        alert("D√°n prompt m·∫´u v√†o tr∆∞·ªõc ƒë√£ nha.");
        return "";
      }

      if (provider !== "openai") {
        alert(
          "Module chu·∫©n ho√° prompt hi·ªán ch·ªâ h·ªó tr·ª£ OpenAI.\n" +
            "B·∫°n ƒëang ch·ªçn: " +
            provider +
            ". Vui l√≤ng ch·ªçn OpenAI trong ph·∫ßn c·∫•u h√¨nh AI."
        );
        return "";
      }

      if (!apiKey) {
        alert(
          "Ch∆∞a c√≥ OpenAI API key.\n" +
            "- Nh·∫≠p key v√†o √¥ OpenAI API Key, HO·∫∂C\n" +
            "- ƒê·∫£m b·∫£o b·∫°n ƒë√£ l∆∞u profile OpenAI trong Admin (localStorage.apiProfiles)."
        );
        return "";
      }

      const mode =
        target === "video"
          ? "short animation video (1‚Äì3 seconds)"
          : "single illustration image";

      const userContent = `
You are a prompt formatter for the Vietnamese chibi universe "X√≥m Ng√†n Chuy·ªán".

Your job:
- Take the raw prompt below (may come from any AI tool).
- Rewrite it into ONE clean English prompt that strictly follows the ADN of "X√≥m Ng√†n Chuy·ªán".

ADN:
- 2D pastel chibi style
- Green & brown Vietnamese village / primary school vibe
- Setting: Vietnamese primary school or small neighbourhood
- Warm, funny, lighthearted, not dark, not violent.

Output:
- One single English prompt for a ${mode}.
- No explanation, no numbering.

Raw prompt:
"""${rawSamplePrompt.trim()}"""
      `.trim();

      try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              {
                role: "system",
                content:
                  "You convert any raw prompt into the ADN style of the Vietnamese chibi universe X√≥m Ng√†n Chuy·ªán."
              },
              { role: "user", content: userContent }
            ],
            temperature: 0.8,
            max_tokens: 400
          })
        });

        if (!res.ok) {
          console.error("OpenAI XNC analyzer error:", await res.text());
          alert("L·ªói khi g·ªçi OpenAI ƒë·ªÉ chu·∫©n ho√° prompt.");
          return "";
        }

        const data = await res.json();
        const text =
          data.choices?.[0]?.message?.content?.trim() || "";

        return text;
      } catch (err) {
        console.error("L·ªói callXNCAnalyzer:", err);
        alert("C√≥ l·ªói k·∫øt n·ªëi khi chu·∫©n ho√° prompt.");
        return "";
      }
    }

    /* ========= Logic XNC cho ·∫¢NH ========= */
    document.addEventListener("DOMContentLoaded", function () {
      initProviderSelectLocal();

      const adnSelect = document.getElementById("xncAdnProfile");

      const imageIdInput = document.getElementById("xncImageId");
      const actionInput = document.getElementById("xncAction");
      const contextInput = document.getElementById("xncContext");

      const charSelect = document.getElementById("xncCharacter");
      const sigSelect = document.getElementById("xncSignature");
      const cameraSelect = document.getElementById("xncCamera");
      const emotionSelect = document.getElementById("xncEmotion");
      const extraMoodInput = document.getElementById("xncExtraMood");

      const output = document.getElementById("xncOutput");

      const jsonOutput = document.getElementById("xncJsonOutput");
      const btnGenJson = document.getElementById("btnGenJson");
      const btnCopyJson = document.getElementById("btnCopyJson");

      const btnGenPrompt = document.getElementById("btnGenPrompt");
      const btnCopyPrompt = document.getElementById("btnCopyPrompt");
      const btnNormalizeImage = document.getElementById("btnNormalizeImage");

      if (!window.XNC) {
        console.error("XNC core not found");
        return;
      }

      function loadProfileAndFill() {
        const profileId = adnSelect.value || "xomnganchuyen";

        charSelect.innerHTML =
          '<option value="">-- Ch·ªçn nh√¢n v·∫≠t --</option>';
        sigSelect.innerHTML =
          '<option value="">-- Ch·ªçn (kh√¥ng b·∫Øt bu·ªôc) --</option>';

        XNC.setProfile(profileId)
          .then(() => {
            const chars = XNC.getCharacterList();
            chars.forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c.id;
              opt.textContent = `${c.name} ‚Äì ${c.role}`;
              charSelect.appendChild(opt);
            });
          })
          .catch((e) => console.error(e));
      }

      XNC.ready(() => {
        loadProfileAndFill();
      });

      adnSelect.addEventListener("change", () => {
        loadProfileAndFill();
      });

      charSelect.addEventListener("change", () => {
        const id = charSelect.value;
        sigSelect.innerHTML =
          '<option value="">-- Ch·ªçn (kh√¥ng b·∫Øt bu·ªôc) --</option>';
        if (!id) return;

        const sigs = XNC.getSignaturesFor(id);
        sigs.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.label;
          sigSelect.appendChild(opt);
        });
      });

      function buildImagePrompt() {
        const characterId = charSelect.value;
        const signatureId = sigSelect.value || "";
        const actionText = actionInput.value.trim();
        const contextText = contextInput.value.trim();
        const cameraKey = cameraSelect.value || "";
        const emotionKey = emotionSelect.value || "comedy";
        const extraMood = extraMoodInput.value.trim();

        if (!characterId || !actionText || !contextText) {
          alert("Vui l√≤ng nh·∫≠p H√†nh ƒë·ªông, B·ªëi c·∫£nh v√† ch·ªçn Nh√¢n v·∫≠t.");
          return null;
        }

        const basePrompt = XNC.buildCharacterPrompt({
          characterId,
          signatureId,
          actionText,
          emotionKey,
          contextText,
          cameraKey,
          lightingKey: "school_daylight",
          extraMood
        });

        return basePrompt;
      }

      btnGenPrompt.addEventListener("click", () => {
        const p = buildImagePrompt();
        if (p) {
          output.value = p;
        }
      });

      btnCopyPrompt.addEventListener("click", () => {
        const text = output.value.trim();
        if (!text) {
          alert("Ch∆∞a c√≥ prompt ·∫£nh ƒë·ªÉ copy.");
          return;
        }
        navigator.clipboard.writeText(text);
        alert("ƒê√£ copy prompt ·∫£nh.");
      });

      btnNormalizeImage.addEventListener("click", async () => {
        const sample = document.getElementById("xncSamplePrompt").value;
        const result = await callXNCAnalyzer(sample, "image");
        if (result) {
          output.value = result;
        }
      });

      function buildImageJson() {
        const imageId = imageIdInput.value.trim();
        const actionText = actionInput.value.trim();
        const contextText = contextInput.value.trim();
        const characterId = charSelect.value;
        const signatureId = sigSelect.value || "";
        const cameraKey = cameraSelect.value || "";
        const emotionKey = emotionSelect.value || "comedy";
        const extraMood = extraMoodInput.value.trim();
        const imgPrompt = output.value.trim();

        if (!imageId) {
          alert("Vui l√≤ng nh·∫≠p ID image / ID c·∫£nh.");
          return null;
        }
        if (!actionText || !contextText || !characterId) {
          alert("Thi·∫øu H√†nh ƒë·ªông, B·ªëi c·∫£nh ho·∫∑c Nh√¢n v·∫≠t.");
          return null;
        }
        if (!imgPrompt) {
          alert("B·∫°n ch∆∞a t·∫°o prompt ·∫£nh. B·∫•m 'T·∫°o Prompt ·∫£nh' ho·∫∑c 'Chu·∫©n ho√°' tr∆∞·ªõc.");
          return null;
        }

        const obj = {
          id: imageId,
          type: "image",
          series: XNC.getCurrentProfileId(),
          characterId: characterId,
          signatureId: signatureId || null,
          action: actionText,
          context: contextText,
          camera: cameraKey || null,
          emotion: emotionKey,
          mood: extraMood || null,
          prompt: imgPrompt,
          createdAt: new Date().toISOString()
        };

        return JSON.stringify(obj, null, 2);
      }

      btnGenJson.addEventListener("click", () => {
        const json = buildImageJson();
        if (json) {
          jsonOutput.value = json;
        }
      });

      btnCopyJson.addEventListener("click", () => {
        const text = jsonOutput.value.trim();
        if (!text) {
          alert("Ch∆∞a c√≥ JSON ƒë·ªÉ copy. B·∫•m 'T·∫°o JSON' tr∆∞·ªõc.");
          return;
        }
        navigator.clipboard.writeText(text);
        alert("ƒê√£ copy JSON c·∫£nh ·∫£nh.");
      });
    });
  </script>
</body>
</html>

