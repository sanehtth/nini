<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XNC Podcast Studio (Full Mixer)</title>
    <link rel="stylesheet" href="/public/style.css">
    <link rel="stylesheet" href="/public/green-theme.css">
    
    <style>
        /* GIỮ THEME DNA */
        body {
            background: linear-gradient(135deg, #CDECC1 0%, #F4E8A2 100%);
            font-family: 'Segoe UI', sans-serif; color: #5D4037; padding: 20px;
        }

        .studio-card {
            background: rgba(255, 255, 255, 0.98); max-width: 1200px; margin: 0 auto;
            border-radius: 25px; box-shadow: 0 20px 50px rgba(139, 94, 60, 0.15);
            border: 4px solid #fff; overflow: hidden; min-height: 90vh; display: flex; flex-direction: column;
        }

        .studio-header {
            background: #8CCB7A; padding: 15px 30px; color: white;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid #B9885D;
        }

        .main-layout { display: grid; grid-template-columns: 300px 1fr; height: 100%; flex-grow: 1; }

        /* SIDEBAR: ASSETS & TOOLS */
        .sidebar {
            background: #F1F8E9; border-right: 1px solid #C5E1A5; padding: 20px;
            display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
        }

        .tool-box { background: white; padding: 15px; border-radius: 12px; border: 1px solid #DCEDC8; }
        .tool-title { font-size: 12px; font-weight: bold; color: #558B2F; margin-bottom: 10px; text-transform: uppercase; }

        .btn-upload {
            background: #B9885D; color: white; padding: 8px; width: 100%; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .btn-tts { background: #8CCB7A; color: white; padding: 8px; width: 100%; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* MAIN TIMELINE AREA */
        .timeline-area {
            background: #FFFDE7; padding: 20px; display: flex; flex-direction: column;
        }

        /* TRACKS */
        .track-container {
            flex-grow: 1; background: white; border: 2px dashed #FFD54F; border-radius: 15px;
            padding: 20px; overflow-y: auto; margin-bottom: 20px;
        }

        .track-label { font-weight: bold; margin-bottom: 10px; color: #F57F17; display: flex; justify-content: space-between; }
        
        .timeline-items {
            display: flex; flex-direction: column; gap: 10px;
        }

        .timeline-block {
            display: flex; align-items: center; padding: 10px; border-radius: 8px; border: 1px solid #ddd;
            background: #FAFAFA; gap: 10px; transition: 0.2s;
        }
        .timeline-block:hover { border-color: #8CCB7A; box-shadow: 0 5px 10px rgba(0,0,0,0.05); }

        .block-icon { font-size: 20px; width: 30px; text-align: center; }
        .block-type-voice { background: #E3F2FD; border-left: 5px solid #2196F3; }
        .block-type-sfx { background: #FCE4EC; border-left: 5px solid #E91E63; }
        
        .block-content { flex-grow: 1; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .block-ctrls { display: flex; gap: 5px; }

        /* PLAYER CONTROLS */
        .player-bar {
            background: #263238; color: white; padding: 15px 30px; border-radius: 15px;
            display: flex; align-items: center; gap: 20px;
        }
        .btn-play {
            width: 50px; height: 50px; border-radius: 50%; border: none; background: #FF5722; color: white; font-size: 20px; cursor: pointer;
        }
        .btn-export {
            background: white; color: #263238; padding: 10px 20px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; margin-left: auto;
        }
        .btn-export:hover { background: #8CCB7A; color: white; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

    </style>
</head>
<body>

<div class="studio-card">
    <div class="studio-header">
        <div>
            <h2 style="margin:0">🎛️ XNC Podcast Mixer</h2>
            <p style="margin:0; font-size:13px; opacity:0.9">Trộn giọng AI + SFX + Nhạc nền</p>
        </div>
        <div id="apiStatus" style="font-size:12px; background:#ffffff33; padding:5px 15px; border-radius:15px;">API Key...</div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="tool-box">
                <div class="tool-title">1. Tạo Giọng (OpenAI)</div>
                <textarea id="ttsInput" rows="3" style="width:100%; border:1px solid #ccc; border-radius:5px; padding:5px; margin-bottom:5px;" placeholder="Nhập thoại vào đây..."></textarea>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <select id="ttsVoice" style="width:60%">
                        <option value="nova">👩 Nova (Nữ)</option>
                        <option value="shimmer">👩 Shimmer (Nữ)</option>
                        <option value="onyx">👨 Onyx (Nam)</option>
                        <option value="fable">👨 Fable (Nam)</option>
                    </select>
                    <button class="btn-tts" onclick="generateTTS()">🎙️ Tạo</button>
                </div>
            </div>

            <div class="tool-box">
                <div class="tool-title">2. Kho Âm Thanh (Upload)</div>
                <input type="file" id="sfxUpload" accept="audio/*" style="display:none" onchange="handleFileUpload(this, 'sfx')">
                <button class="btn-upload" onclick="document.getElementById('sfxUpload').click()">📂 Tải SFX (Tiếng động)</button>
                <br><br>
                <input type="file" id="bgmUpload" accept="audio/*" style="display:none" onchange="handleFileUpload(this, 'bgm')">
                <button class="btn-upload" style="background:#5D4037" onclick="document.getElementById('bgmUpload').click()">🎵 Tải Nhạc Nền (Loop)</button>
            </div>
            
            <div class="tool-box">
                 <div class="tool-title">Hướng dẫn</div>
                 <p style="font-size:12px; margin:0">1. Tạo giọng hoặc Upload SFX.<br>2. Nó sẽ tự nhảy vào Timeline bên phải.<br>3. Kéo thả (sắp tới) hoặc xóa để sắp xếp.<br>4. Bấm Play để nghe thử -> Xuất file.</p>
            </div>
        </div>

        <div class="timeline-area">
            
            <div style="margin-bottom:15px; background:#EFEBE9; padding:10px; border-radius:10px; display:flex; align-items:center; gap:10px;">
                <span style="font-weight:bold; font-size:13px; color:#5D4037;">🎵 Nhạc nền:</span>
                <div id="bgmName" style="font-size:13px; color:#888; flex-grow:1; font-style:italic;">(Chưa có nhạc nền)</div>
                <input type="range" id="bgmVol" min="0" max="1" step="0.1" value="0.3" title="Volume">
            </div>

            <div class="track-container">
                <div class="track-label">
                    <span>🎞️ DÒNG CHÍNH (Thoại & SFX nối tiếp nhau)</span>
                    <button onclick="clearTimeline()" style="border:none; background:none; color:#C62828; cursor:pointer; font-size:12px;">🗑️ Xóa hết</button>
                </div>
                <div id="timelineList" class="timeline-items">
                    </div>
            </div>

            <div class="player-bar">
                <button class="btn-play" onclick="playProject()">▶</button>
                <div id="statusText" style="font-size:14px;">Sẵn sàng</div>
                <button class="btn-export" onclick="exportProject()">💾 XUẤT PODCAST (.WEBM)</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === CẤU HÌNH ===
    const PROFILE_ID = "default";
    let openaiKey = "";
    
    // DỮ LIỆU DỰ ÁN
    let timeline = []; // [{type: 'voice'|'sfx', blob: Blob, name: '...'}, ...]
    let bgmBlob = null;
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();

    window.onload = () => {
        const k1 = `lq_api_${PROFILE_ID}_openai`;
        openaiKey = localStorage.getItem(k1);
        const statusDiv = document.getElementById('apiStatus');
        if(openaiKey) {
            statusDiv.innerHTML = "✅ OpenAI Connected";
            statusDiv.style.background = "#DCEDC8"; statusDiv.style.color = "#33691E";
        } else {
            statusDiv.innerHTML = "⚠️ Missing OpenAI Key";
            statusDiv.style.background = "#FFCDD2"; statusDiv.style.color = "#C62828";
        }
    }

    // --- 1. XỬ LÝ TTS (TẠO GIỌNG) ---
    async function generateTTS() {
        const text = document.getElementById('ttsInput').value;
        const voice = document.getElementById('ttsVoice').value;
        const btn = document.querySelector('.btn-tts');

        if(!text) return alert("Nhập nội dung thoại!");
        if(!openaiKey) return alert("Chưa có API Key!");

        btn.disabled = true; btn.innerText = "⏳...";

        try {
            const response = await fetch("https://api.openai.com/v1/audio/speech", {
                method: "POST",
                headers: { "Authorization": `Bearer ${openaiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "tts-1", input: text, voice: voice })
            });
            if(!response.ok) throw new Error("Lỗi OpenAI TTS");
            
            const blob = await response.blob();
            addToTimeline('voice', blob, text.substring(0, 30) + "...");
            document.getElementById('ttsInput').value = ""; // Clear input

        } catch (e) { alert(e.message); } 
        finally { btn.disabled = false; btn.innerText = "🎙️ Tạo"; }
    }

    // --- 2. XỬ LÝ UPLOAD FILE ---
    function handleFileUpload(input, type) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            if(type === 'bgm') {
                bgmBlob = file;
                document.getElementById('bgmName').innerText = file.name;
                document.getElementById('bgmName').style.color = "#33691E";
                document.getElementById('bgmName').style.fontStyle = "normal";
            } else {
                addToTimeline('sfx', file, file.name);
            }
        }
        input.value = ""; // Reset
    }

    // --- 3. QUẢN LÝ TIMELINE ---
    function addToTimeline(type, blob, name) {
        timeline.push({ type, blob, name });
        renderTimeline();
    }

    function renderTimeline() {
        const container = document.getElementById('timelineList');
        container.innerHTML = "";
        timeline.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `timeline-block ${item.type === 'voice' ? 'block-type-voice' : 'block-type-sfx'}`;
            div.innerHTML = `
                <div class="block-icon">${item.type === 'voice' ? '🗣️' : '🔊'}</div>
                <div class="block-content"><b>${index+1}.</b> ${item.name}</div>
                <div class="block-ctrls">
                    <button onclick="previewItem(${index})">▶</button>
                    <button onclick="removeItem(${index})" style="color:red">×</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function removeItem(index) { timeline.splice(index, 1); renderTimeline(); }
    function clearTimeline() { timeline = []; renderTimeline(); }

    function previewItem(index) {
        const url = URL.createObjectURL(timeline[index].blob);
        new Audio(url).play();
    }

    // --- 4. ENGINE TRỘN ÂM THANH (CORE) ---
    async function playProject(isExport = false) {
        if(timeline.length === 0) return alert("Timeline trống!");
        
        const status = document.getElementById('statusText');
        status.innerText = isExport ? "Đang xuất file..." : "Đang phát...";

        // Tạo Destination (Loa hoặc Recorder)
        const dest = audioContext.createMediaStreamDestination();
        
        // Setup Recorder nếu là Export
        let mediaRecorder;
        let chunks = [];
        if(isExport) {
            mediaRecorder = new MediaRecorder(dest.stream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { 'type' : 'audio/webm; codecs=opus' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `podcast_xnc_${Date.now()}.webm`;
                a.click();
                status.innerText = "✅ Đã xuất file!";
            };
            mediaRecorder.start();
        }

        // 1. Chơi Nhạc Nền (BGM)
        let bgmSource;
        if(bgmBlob) {
            const bgmBuf = await fileToAudioBuffer(bgmBlob);
            bgmSource = audioContext.createBufferSource();
            bgmSource.buffer = bgmBuf;
            bgmSource.loop = true;
            
            const gain = audioContext.createGain();
            gain.gain.value = document.getElementById('bgmVol').value;
            
            bgmSource.connect(gain);
            gain.connect(dest); // Kết nối vào dest để thu âm
            if(!isExport) gain.connect(audioContext.destination); // Kết nối ra loa để nghe
            
            bgmSource.start(0);
        }

        // 2. Chơi tuần tự Timeline
        for (const item of timeline) {
            const buf = await fileToAudioBuffer(item.blob);
            const source = audioContext.createBufferSource();
            source.buffer = buf;
            source.connect(dest);
            if(!isExport) source.connect(audioContext.destination);
            
            source.start(0);
            
            // Đợi hết file này mới chơi file tiếp (Await duration)
            await new Promise(r => setTimeout(r, (buf.duration * 1000) + 100)); // +100ms gap
        }

        // Kết thúc
        if(bgmSource) bgmSource.stop();
        if(isExport && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        if(!isExport) status.innerText = "Đã phát xong";
    }

    function exportProject() {
        playProject(true);
    }

    // Helper: Chuyển Blob/File thành AudioBuffer
    async function fileToAudioBuffer(blob) {
        const arrayBuffer = await blob.arrayBuffer();
        return await audioContext.decodeAudioData(arrayBuffer);
    }

</script>

</body>
</html>